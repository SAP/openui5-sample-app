/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/i18n/Localization","sap/base/util/array/diff","sap/ui/base/Object","sap/base/util/merge","sap/base/util/deepEqual","sap/m/p13n/SelectionPanel","sap/m/p13n/modules/xConfigAPI","sap/ui/core/Locale","sap/ui/core/Lib","sap/ui/core/mvc/View"],(t,e,n,o,i,s,r,a,c,p)=>{"use strict";const l=n.extend("sap.m.p13n.SelectionController",{constructor:function(t){n.call(this);this._oAdaptationControl=t.control;this._sPersistenceIdentifier=t.persistenceIdentifier?t.persistenceIdentifier:null;this._oMetadataHelper=t.helper?t.helper:null;this._aStableKeys=t.stableKeys||[];if(!this._oAdaptationControl){throw new Error("Always provide atleast a 'control' configuration when creating a new p13n controller!")}this._sTargetAggregation=t.targetAggregation;this._fSelector=t.getKeyForItem;this._oP13nData=null;this._bLiveMode=false;this._bResetEnabled=false;this._bReorderingEnabled=t.hasOwnProperty("enableReorder")?t.enableReorder:true}});l.prototype.getPersistenceIdentifier=function(){return this._sPersistenceIdentifier};l.prototype.getMetadataHelper=function(){return this._oMetadataHelper};l.prototype.getAdaptationControl=function(){return this._oAdaptationControl};l.prototype.getTargetAggregation=function(){return this._sTargetAggregation};l.prototype.getChangeOperations=()=>({add:"addItem",remove:"removeItem",move:"moveItem"});l.prototype.getSelectorForReset=function(){return this._oAdaptationControl};l.prototype.sanityCheck=t=>t;l.prototype.formatToInternalState=t=>t;l.prototype.initAdaptationUI=function(t){const e=this.mixInfoAndState(t);this._oPanel=this.createUI(e);return Promise.resolve(this._oPanel)};l.prototype.createUI=function(t){const e=new s({showHeader:true,enableCount:true});e.setEnableReorder(this._bReorderingEnabled);return e.setP13nData(t.items)};const g=t=>{if(t instanceof p){return t}if(t&&typeof t.getParent==="function"){t=t.getParent();return g(t)}};l.prototype._calcPresentState=function(){const t=[],e=this.getAdaptationControl().getAggregation(this.getTargetAggregation())||[];const n=g(this.getAdaptationControl());e.forEach((e,o)=>{const i=e.getVisible()?e.data("p13nKey"):null;const s=n?n.getLocalId(e.getId()):e.getId();const r=i||(this._fSelector?this._fSelector(e):e.getVisible());if(r){t.push({key:typeof r==="boolean"?s:r})}});return t};l.prototype.getCurrentState=function(){const t=this._calcPresentState();const e=r.readConfig(this.getAdaptationControl())||{};const n=e.hasOwnProperty("aggregations")?e.aggregations[this._sTargetAggregation]:{};const o=[];if(n){Object.entries(n).forEach(([t,e])=>{o.push({key:t,position:e.position,visible:e.visible})});o.sort((t,e)=>t.position-e.position)}o.sort((t,e)=>t.position-e.position);o.forEach(({key:e})=>{const o=t.map(t=>t.key);let i=o.indexOf(e);const s=n[e].position;const r=n[e].visible!==false;const a=s!==undefined;if(r&&i===-1){t.push({key:e})}if(r&&a&&t.length>0){const e=t.splice(i,1)[0];t.splice(s,0,e);i=s}if(n[e].visible===false&&i>-1){t.splice(i,1)}});return t};l.prototype.getStateKey=()=>"items";l.prototype.getDelta=function(t){const e=this._getPresenceAttribute(t.externalAppliance);const n=t=>t.hasOwnProperty(e)&&t[e]===false?false:true;const o=t.applyAbsolute?t.changedState.filter(n):this._getFilledArray(t.existingState,t.changedState,e).filter(n);this._aStableKeys.forEach((t,e)=>{const n=this.arrayToMap(this.getCurrentState());const i=this.arrayToMap(o);const s=n[t]||e-1;if(!i.hasOwnProperty(t)){o.splice(s,0,n[t])}});t.changedState=o;if(i(t.existingState,o)){return[]}else{return this.getArrayDeltaChanges(t)}};l.prototype.getArrayDeltaChanges=function(t){const e=t.existingState;const n=t.changedState;const o=t.control;const i=t.changeOperations.add;const s=t.changeOperations.remove;const r=t.changeOperations.move;const a=t.deltaAttributes||[];const c=this._calculateDeleteInserts(e,n,a);let p=this._createAddRemoveChanges(c.deletes,o,s,a);if(r){const t=this._removeItems(e,c.deletes);const i=this._removeItems(n,c.inserts);const s=this._createMoveChanges(t,i,o,r,a);p=p.concat(s)}const l=this._createAddRemoveChanges(c.inserts,o,i,a);p=p.concat(l);return p};l.prototype._createMoveChanges=function(t,n,o,i,s){const r=[];if(t.length!==n.length){return r}const a=t=>{let e="";s.forEach(n=>{e=e+t[n]});return e};const c="insert";const p="delete";const l=[];const g=[];const h=e(t,n,a);for(let t=0;t<h.length;t++){const e=h[t].type;if(e!==p&&e!==c){continue}const{index:o}=h[t];const i=n[o];if(!i){continue}if(e===p){l.push({...i,index:o});continue}if(e===c){g.push({...i,index:o});continue}}for(let t=0;t<h.length;t++){if(h[t].type==="insert"){const e=n[h[t].index].key||n[h[t].index].name;let s=h[t].index;const a=t=>{if(!t){return false}if(t.index>=s){return false}return true};const c=l.filter(a).length;const p=g.filter(a).length;const u=s>0;const f=c>0;const d=p>c;const y=c>p;const _=d&&f&&u;const m=y&&u;if(_){s-=p}else if(m){s+=c}r.push(this._createMoveChange(e,Math.min(s,n.length-1),i,o))}}return r};l.prototype._createAddRemoveChanges=function(t,e,n,o){const i=[];for(let s=0;s<t.length;s++){i.push(this._createAddRemoveChange(e,n,this._getChangeContent(t[s],o)))}return i};l.prototype._removeItems=function(t,e){let n;const o=[];for(let i=0;i<t.length;i++){n=t[i].key||t[i].name;if(this._indexOfByKeyName(e,n)===-1){o.push(t[i])}}return o};l.prototype._indexOfByKeyName=(t,e)=>{let n=-1;t.some((t,o)=>{if(t.key===e||t.name===e){n=o}return n!=-1});return n};l.prototype._calculateDeleteInserts=function(t,e,n){let i,s,r,a;const c={deletes:[],inserts:[]};for(i=0;i<t.length;i++){s=t[i].key||t[i].name;a=this._indexOfByKeyName(e,s);if(a===-1){r=o({},t[i]);c.deletes.push(r)}else if(n.length){if(this._verifyDeltaAttributes(t[i],e[a],n)){c.deletes.push(t[i]);r=o({},e[a]);r.index=a;c.inserts.push(r)}}}for(i=0;i<e.length;i++){s=e[i].key||e[i].name;if(this._indexOfByKeyName(t,s)===-1){r=o({},e[i]);r.index=i;c.inserts.push(r)}}return c};l.prototype._verifyDeltaAttributes=(t,e,n)=>{let o=false;n.some(n=>{if(!t.hasOwnProperty(n)&&e.hasOwnProperty(n)||t.hasOwnProperty(n)&&!e.hasOwnProperty(n)||t[n]!=e[n]){o=true}return o});return o};l.prototype._getChangeContent=(t,e)=>{const n={};if(t.hasOwnProperty("index")&&t.index>=0){n.index=t.index}e.forEach(e=>{if(t.hasOwnProperty(e)){n[e]=t[e]}});return n};l.prototype._createAddRemoveChange=function(t,e,n){const o=n;if(e.indexOf("set")!==0&&e.indexOf("reset")!==0){o.value=e==this.getChangeOperations()["add"]}if(this.getTargetAggregation()){o.targetAggregation=this.getTargetAggregation()}if(this._sPersistenceIdentifier){o.persistenceIdentifier=this._sPersistenceIdentifier}const i={selectorElement:t,changeSpecificData:{changeType:e,content:o}};return i};l.prototype._createMoveChange=function(t,e,n,o){const i={key:t,targetAggregation:this.getTargetAggregation(),index:e};if(this._sPersistenceIdentifier){i.persistenceIdentifier=this._sPersistenceIdentifier}const s={selectorElement:o,changeSpecificData:{changeType:n,content:i}};return s};l.prototype._getPresenceAttribute=t=>"visible";l.prototype.getBeforeApply=()=>Promise.resolve();l.prototype.mixInfoAndState=function(t){const e=this.getCurrentState();const n=this.arrayToMap(e);const o=this.prepareAdaptationData(t,(t,e)=>{const o=n[e.name||e.key];t.visible=!!o;t.position=o?o.position:-1;return!(e.visible===false||this._aStableKeys.indexOf(e.name||e.key)>-1)});this.sortP13nData({visible:"visible",position:"position"},o.items);o.items.forEach(t=>{delete t.position});return o};l.prototype.getP13nData=function(){return this._oPanel?this._oPanel.getP13nData():this._oAdaptationModel&&this._oAdaptationModel.getProperty("/items")};l.prototype.model2State=false;l.prototype.update=function(t){if(this._oPanel){if(!this._oPanel.isDestroyed()){const e=this.mixInfoAndState(t);this._oPanel.setP13nData(e.items)}}else if(this._oAdaptationModel){const e=this.mixInfoAndState(t);this._oAdaptationModel.setProperty("/items",e.items);this._oAdaptationModel.setProperty("/itemsGrouped",e.itemsGrouped)}};l.prototype._getFilledArray=function(t,e,n){const i=o([],t);const s=o([],e);s.forEach(t=>{const e=this.arrayToMap(i);const o=e[t.key];if(!t.hasOwnProperty(n)||t[n]){let e=t.position;if(o){e=e>-1?e:o.position;const t=o.position;i.splice(e,0,i.splice(t,1)[0])}else{e=e>-1?e:i.length;i.splice(e,0,t)}i[e]=t}else if(o){i[o.position][n]=false}});return i};l.prototype.getPropertySetterChanges=function(t){const e=t.control;const n=t.existingState;const o=t.changedState;const i=t.operation;const s=t.deltaAttribute;const r=[];o.forEach(t=>{if(t.hasOwnProperty(s)){const o=n.find(e=>e.name==t.name);const a=o&&o.hasOwnProperty(s)&&o[s];const c=t[s];const p=a!==c;if(p){r.push(this._createAddRemoveChange(e,i,{[t.hasOwnProperty("key")?"key":"name"]:t.key||t.name,targetAggregation:this.getTargetAggregation(),value:t[s]}))}}});return r};l.prototype.changesToState=function(t){const e=[];t.forEach(t=>{const n=o({},t.changeSpecificData.content);const i=n.index;delete n.index;if(i!==undefined){n.position=i}if(t.changeSpecificData.changeType===this.getChangeOperations()["remove"]){n[this._getPresenceAttribute()]=false}e.push(n)});return e};l.prototype.prepareAdaptationData=function(t,e,n){const o=[];const i=n?{}:null;const s=e instanceof Function;const r=this.getMetadataHelper();const a=r?r:t;a.getProperties().forEach(t=>{const n={};n.key=t.name||t.key;n.name=t.name||t.key;if(s){const o=e(n,t);if(!o){return}}n.label=t.label||n.key;n.tooltip=t.tooltip;if(i){n.group=t.group?t.group:"BASIC";n.groupLabel=t.groupLabel;i[n.group]=i[n.group]?i[n.group]:[];i[n.group].push(n)}o.push(n)});const c={items:o};if(i){c.itemsGrouped=this._buildGroupStructure(i)}return c};l.prototype._buildGroupStructure=function(t){const e=[];Object.keys(t).forEach(n=>{this.sortP13nData("generic",t[n]);e.push({group:n,groupLabel:t[n][0].groupLabel||c.getResourceBundleFor("sap.m").getText("p13n.BASIC_DEFAULT_GROUP"),groupVisible:true,items:t[n]})});return e};l.prototype.sortP13nData=(e,n)=>{const o=e;const i=o.position;const s=o.visible;const r=new a(t.getLanguageTag()).toString();const c=window.Intl.Collator(r,{});n.sort((t,e)=>{if(t[s]&&e[s]){return(t[i]||0)-(e[i]||0)}else if(t[s]){return-1}else if(e[s]){return 1}else if(!t[s]&&!e[s]){return c.compare(t.label,e.label)}})};l.prototype.arrayToMap=t=>t.reduce((t,e,n)=>{t[e.key]=e;t[e.key].position=n;return t},{});l.prototype.destroy=function(){n.prototype.destroy.apply(this,arguments);this._oAdaptationControl=null;this._bLiveMode=null;this._oPanel=null;this._bResetEnabled=null;this._oAdaptationModel=null};return l});
//# sourceMappingURL=SelectionController.js.map