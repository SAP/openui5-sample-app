/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./PluginBase","sap/base/i18n/Localization","sap/ui/core/Element","sap/ui/core/InvisibleText","sap/ui/Device","sap/m/ColumnPopoverActionItem","sap/m/table/columnmenu/QuickAction","sap/m/table/columnmenu/QuickResize","sap/m/Button","sap/ui/core/Lib","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/Aria"],function(e,t,i,n,o,s,a,r,l,u,jQuery){"use strict";var h=e.extend("sap.m.plugins.ColumnResizer",{metadata:{library:"sap.m",properties:{},events:{columnResize:{allowPreventDefault:true,parameters:{column:{type:"sap.ui.core.Element"},width:{type:"sap.ui.core.CSSSize"}}}}}});var d={};var c=false;var f="sapMPluginsColumnResizer";var p=t.getRTL();var m=p?"right":"left";var C=p?"left":"right";var _=p?-1:1;h.findOn=h.getPlugin=e.findOn;h.prototype.init=function(){this._iHoveredColumnIndex=-1;this._aPositions=[];this._oHandle=null};h.prototype.onActivate=function(e){e.addEventDelegate(this,this);if(e.isActive()){this.onAfterRendering()}};h.prototype.onDeactivate=function(e){e.removeEventDelegate(this,this);this.onBeforeRendering();this._oHandle=null};h.prototype.onBeforeRendering=function(){if(this._$Container){this._$Container.removeClass(f+"Container").off("."+f);this._$Container.find(this.getConfig("resizable")).removeClass(f+"Resizable");this._updateAriaDescribedBy("remove")}};h.prototype.onAfterRendering=function(){this._$Container=this.getControl().$(this.getConfig("container"));o.system.desktop&&this._$Container.on("mousemove."+f,this._onmousemove.bind(this));this._$Container.addClass(f+"Container").on("mouseleave."+f,this._onmouseleave.bind(this));this._aResizables=this._$Container.find(this.getConfig("resizable")).addClass(f+"Resizable").get();this._updateAriaDescribedBy("add");this._invalidatePositions()};h.prototype._updateAriaDescribedBy=function(e){this._aResizables.forEach(function(t){var o=i.closestTo(t,true);var s=o&&o.getFocusDomRef();jQuery(s)[e+"AriaDescribedBy"](n.getStaticId("sap.m","COLUMNRESIZER_RESIZABLE"))})};h.prototype.ontouchstart=function(e){if(this.getConfig("allowTouchResizing")&&jQuery(e.target).closest(this._aResizables)[0]){this._onmousemove(e)}else if(this._iHoveredColumnIndex==-1&&this._oHandle?.isConnected&&this._oHandle.style[m]){this._onmousemove(e);if(this._iHoveredColumnIndex==-1){this._oHandle.style[m]="";this._oAlternateHandle.style[m]=""}}c=this._iHoveredColumnIndex>-1;if(!c){return}this._startResizeSession(this._iHoveredColumnIndex);d.iTouchStartX=e.targetTouches[0].clientX;d.fHandleX=parseFloat(this._oHandle.style[m]);this._$Container.addClass(f+"Resizing");jQuery(document).on("touchend."+f+" mouseup."+f,this._ontouchend.bind(this))};h.prototype.ontouchmove=function(e){if(!c){return}this._setSessionDistanceX(e.targetTouches[0].clientX-d.iTouchStartX);this._oHandle.style[m]=d.fHandleX+d.iDistanceX+"px"};h.prototype._onmousemove=function(e){if(c||this.getControl().getBusy()||this.getControl().getBlocked()){return}this._setPositions();var t=e.targetTouches?e.targetTouches[0].clientX:e.clientX;var i=this._getHoveredColumnIndex(t);this._displayHandle(i)};h.prototype._onmouseleave=function(){this._invalidatePositions();this.onsapescape()};h.prototype._ontouchend=function(){this._setColumnWidth();this._cancelResizing(true)};h.prototype.onsapescape=function(){if(c){this._cancelResizing()}};h.prototype.onsaprightmodifiers=function(e){this._onLeftRightModifiersKeyDown(e,16)};h.prototype.onsapleftmodifiers=function(e){this._onLeftRightModifiersKeyDown(e,-16)};h.prototype.ondblclick=function(e){var t=e.clientX,i=this._getHoveredColumnIndex(t);if(i==-1){return}this._startResizeSession(i);this._setSessionDistanceX(this._calculateAutoColumnDistanceX());this._setColumnWidth();this._endResizeSession()};h.prototype._getHoveredColumnIndex=function(e){return this._aPositions.findIndex(function(t){return Math.abs(t-e)<=(this._oAlternateHandle||h._isInTouchMode()?20:3)},this)};h.prototype._calculateAutoColumnDistanceX=function(){var e=this.getConfig("columnRelatedCells",this._$Container,d.oCurrentColumn.getId());if(!e||!e.length){return}var t=jQuery("<div></div>").addClass(f+"SizeDetector").addClass(this.getConfig("cellPaddingStyleClass"));var i=e.children().clone().removeAttr("id");this.getConfig("additionalColumnWidth",e,i);this._$Container.append(t);var n=Math.round(t.append(i)[0].getBoundingClientRect().width);var o=p?d.fCurrentColumnWidth-n:n-d.fCurrentColumnWidth;t.remove();return o};h.prototype._invalidatePositions=function(){window.setTimeout(function(){this._bPositionsInvalid=true}.bind(this))};h.prototype._displayHandle=function(e,t){if(this._iHoveredColumnIndex==e){return}if(!this._oHandle){this._oHandle=document.createElement("div");this._oHandle.className=f+"Handle";this._oHandle.onmouseleave=function(){this.style[m]=""};if(t||h._isInTouchMode()){var i=document.createElement("div");i.className=f+"HandleCircle";i.style.top=this._aResizables[e].offsetHeight-8+"px";this._oHandle.appendChild(i);this._oAlternateHandle=this._oHandle.cloneNode(true)}}if(this._$Container[0]!==this._oHandle.parentNode){this._$Container.append(this._oHandle);if(t){this._$Container.append(this._oAlternateHandle)}}if(e>-1){this._oHandle.style[m]=(this._aPositions[e]-this._fContainerX)*_+"px"}else{this._oHandle.remove()}if(t){this._oAlternateHandle.style[m]=--e>-1?(this._aPositions[e]-this._fContainerX)*_+"px":""}else{if(this._oAlternateHandle){this._oAlternateHandle.style[m]=""}this._iHoveredColumnIndex=e}};h.prototype._cancelResizing=function(e){this._$Container.removeClass(f+"Resizing");if(d.iDistanceX||!e){this._oHandle.remove()}else{setTimeout(()=>{this._oHandle.remove()},300)}this._iHoveredColumnIndex=-1;jQuery(document).off("."+f);this._endResizeSession();c=false};h.prototype._getColumnMinWidth=function(e){return e?48:0};h.prototype._startResizeSession=function(e){d.$CurrentColumn=jQuery(this._aResizables[e]);d.oCurrentColumn=i.closestTo(d.$CurrentColumn[0],true);d.fCurrentColumnWidth=d.$CurrentColumn.width();d.iMaxDecrease=this._getColumnMinWidth(d.oCurrentColumn)-d.fCurrentColumnWidth;d.iEmptySpace=this.getConfig("emptySpace",this.getControl());if(d.iEmptySpace!=-1){d.$NextColumn=jQuery(this._aResizables[e+1]);d.oNextColumn=i.closestTo(d.$NextColumn[0],true);d.fNextColumnWidth=d.$NextColumn.width()||0;d.iMaxIncrease=d.iEmptySpace+d.fNextColumnWidth-this._getColumnMinWidth(d.oNextColumn)}else{d.iMaxIncrease=window.innerWidth}if(p){d.iMaxDecrease=this._getColumnMinWidth(d.oNextColumn)-d.fNextColumnWidth;if(d.iEmptySpace!=-1){d.iMaxIncrease=d.iEmptySpace+d.fCurrentColumnWidth-this._getColumnMinWidth(d.oCurrentColumn)}}};h.prototype._setSessionDistanceX=function(e){d.iDistanceX=(e>0?Math.min(e,d.iMaxIncrease):Math.max(e,d.iMaxDecrease))*_};h.prototype._setColumnWidth=function(){if(!d.iDistanceX){return}var e=d.fCurrentColumnWidth+d.iDistanceX+"px";if(!this._fireColumnResize(d.oCurrentColumn,e)){return}d.oCurrentColumn.setWidth(e);if(d.oNextColumn&&(d.iEmptySpace<3||d.iDistanceX>d.iEmptySpace)){e=d.fNextColumnWidth-d.iDistanceX+d.iEmptySpace+"px";if(this._fireColumnResize(d.oNextColumn,e)){d.oNextColumn.setWidth(e)}}this.getConfig("fixAutoWidthColumns")&&this._aResizables.forEach(function(e){var t=jQuery(e),n=i.closestTo(e,true),o=n.getWidth();if(o&&o.toLowerCase()!="auto"){return}o=t.css("width");if(o&&this._fireColumnResize(n,o)){n.setWidth(o)}},this)};h.prototype._fireColumnResize=function(e,t){return this.fireColumnResize({column:e,width:t})};h.prototype._onLeftRightModifiersKeyDown=function(e,t){if(!e.shiftKey||e.ctrlKey||e.metaKey||e.altKey||h.detectTextSelection(e.target)){return}var i=jQuery(e.target).closest(this._aResizables)[0],n=this._aResizables.indexOf(i);if(n===-1){return}this._startResizeSession(n);this._setSessionDistanceX(t);this._setColumnWidth();this._endResizeSession();e.stopImmediatePropagation(true)};h.detectTextSelection=function(e){var t=window.getSelection(),i=t.toString().replace("/n","");return i&&(e!==t.focusNode&&e.contains(t.focusNode))};h.prototype._endResizeSession=function(){d={}};h.prototype._setPositions=function(){if(!this._bPositionsInvalid){return this._aPositions}this._bPositionsInvalid=false;this._fContainerX=this._$Container[0].getBoundingClientRect()[m];this._aPositions=this._aResizables.map(function(e,t,i){return e.getBoundingClientRect()[C]-(++t==i.length?1.25*_:0)},this)};h.prototype.startResizing=function(e){var t=this._aResizables.indexOf(e);this._setPositions();this._displayHandle(t,true)};h.prototype.getColumnResizeQuickAction=function(e,t){if(!h._isInTouchMode()){return}return new a({content:new l({text:u.getResourceBundleFor("sap.m").getText("table.COLUMNMENU_RESIZE"),press:function(){t.close();this.startResizing(e.getDomRef())}.bind(this)})})};h.prototype.getColumnResizeInputQuickAction=function(e){return new r({width:parseInt(getComputedStyle(e.getDomRef()).width),change:[function(t){const i=this.fireColumnResize({column:e,width:t.getParameter("width")+"px"});if(i){e.setWidth(t.getParameter("width")+"px")}},this]})};h.prototype.getColumnResizeButton=function(e){if(!e||!h._isInTouchMode()){return}return new s({text:u.getResourceBundleFor("sap.m").getText("COLUMNRESIZER_RESIZE_BUTTON"),icon:"sap-icon://resize-horizontal",press:this.startResizing.bind(this,e.getDomRef())})};h._isInTouchMode=function(){return window.matchMedia("(hover:none)").matches};e.setConfigs({"sap.m.Table":{container:"listUl",resizable:".sapMListTblHeaderCell",cellPaddingStyleClass:"sapMListTblCell",fixAutoWidthColumns:true,onActivate:function(e){this._vOrigFixedLayout=e.getFixedLayout();if(!e.bActiveHeaders){this.allowTouchResizing=h._isInTouchMode()}e.setFixedLayout("Strict")},onDeactivate:function(e){e.setFixedLayout(this._vOrigFixedLayout);if(this._vOrigFixedLayout=="Strict"){e.invalidate()}delete this._vOrigFixedLayout;delete this.allowTouchResizing},emptySpace:function(e){var t=e.getDomRef("tblHeadDummyCell");return t?t.clientWidth:0},columnRelatedCells:function(e,t){return e.find(".sapMListTblCell[data-sap-ui-column='"+t+"']")},additionalColumnWidth:function(e,t){var i=e[0];if(!i.hasAttribute("aria-sort")||i.getAttribute("aria-sort")==="none"){return}var n=t[0];var o=window.getComputedStyle(i.firstChild,":after");n.style.marginLeft=Math.round(parseInt(o.getPropertyValue("width")))+"px"}}},h);return h});
//# sourceMappingURL=ColumnResizer.js.map