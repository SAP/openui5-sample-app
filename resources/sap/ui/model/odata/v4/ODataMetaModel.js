/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./AnnotationHelper","./ValueListType","./lib/_Helper","sap/base/assert","sap/base/Log","sap/base/util/JSTokenizer","sap/base/util/ObjectPath","sap/ui/base/ManagedObject","sap/ui/base/SyncPromise","sap/ui/model/BindingMode","sap/ui/model/ChangeReason","sap/ui/model/ClientListBinding","sap/ui/model/Context","sap/ui/model/ContextBinding","sap/ui/model/MetaModel","sap/ui/model/PropertyBinding","sap/ui/model/odata/OperationMode","sap/ui/model/odata/type/Boolean","sap/ui/model/odata/type/Byte","sap/ui/model/odata/type/Date","sap/ui/model/odata/type/DateTimeOffset","sap/ui/model/odata/type/Decimal","sap/ui/model/odata/type/Double","sap/ui/model/odata/type/Guid","sap/ui/model/odata/type/Int16","sap/ui/model/odata/type/Int32","sap/ui/model/odata/type/Int64","sap/ui/model/odata/type/Raw","sap/ui/model/odata/type/SByte","sap/ui/model/odata/type/Single","sap/ui/model/odata/type/Stream","sap/ui/model/odata/type/String","sap/ui/model/odata/type/TimeOfDay","sap/ui/thirdparty/URI"],function(e,t,n,i,r,o,a,s,u,l,f,c,d,p,h,y,g,m,$,v,M,b,O,C,P,E,A,w,S,U,x,T,j,L){"use strict";var R=s.extend("sap.ui.model.odata.v4._any",{metadata:{properties:{any:"any"}}}),D,I={},V=r.Level.DEBUG,q=Object.freeze({$kind:"Property",$Type:"Edm.Untyped"}),k={$kind:"ComplexType",$OpenType:true,bbox:{$kind:"Property",$Type:"Edm.Double",$isCollection:true},type:{$kind:"Property",$Nullable:false,$Type:"Edm.String"}},B={...k,coordinates:{$kind:"Property",$Nullable:false,$Type:"Edm.Double",$isCollection:true}},N={"Edm.Geography":{...k,$Abstract:true},"Edm.GeographyLineString":B,"Edm.GeographyMultiLineString":B,"Edm.GeographyMultiPoint":B,"Edm.GeographyMultiPolygon":B,"Edm.GeographyPoint":B,"Edm.GeographyPolygon":B},_=["$count","$selectionCount","@$ui5.node.groupLevelCount","@$ui5.node.level"],F,G=/\$\(/g,W=/^-?\d+$/,K="sap.ui.model.odata.v4.ODataMetaModel",z=/\(.*\)$/,H=new w,Q=/\$\)/g,J={messageChange:true},X={"Edm.Boolean":{Type:m},"Edm.Byte":{Type:$},"Edm.Date":{Type:v},"Edm.DateTimeOffset":{constraints:{$Precision:"precision"},Type:M},"Edm.Decimal":{constraints:{"@Org.OData.Validation.V1.Minimum/$Decimal":"minimum","@Org.OData.Validation.V1.Minimum@Org.OData.Validation.V1.Exclusive":"minimumExclusive","@Org.OData.Validation.V1.Maximum/$Decimal":"maximum","@Org.OData.Validation.V1.Maximum@Org.OData.Validation.V1.Exclusive":"maximumExclusive",$Precision:"precision",$Scale:"scale"},Type:b},"Edm.Double":{Type:O},"Edm.Guid":{Type:C},"Edm.Int16":{Type:P},"Edm.Int32":{Type:E},"Edm.Int64":{Type:A},"Edm.SByte":{Type:S},"Edm.Single":{Type:U},"Edm.Stream":{Type:x},"Edm.String":{constraints:{"@com.sap.vocabularies.Common.v1.IsDigitSequence":"isDigitSequence",$MaxLength:"maxLength"},Type:T},"Edm.TimeOfDay":{constraints:{$Precision:"precision"},Type:j}},Y={},Z="@com.sap.vocabularies.Common.v1.ValueList",ee="@com.sap.vocabularies.Common.v1.ValueListMapping",te="@com.sap.vocabularies.Common.v1.ValueListReferences",ne="@com.sap.vocabularies.Common.v1.ValueListRelevantQualifiers",ie="@com.sap.vocabularies.Common.v1.ValueListWithFixedValues",re=r.Level.WARNING,oe,ae=h.extend("sap.ui.model.odata.v4.ODataMetaModel",{constructor:pe}),se,ue;function le(e,t){if(e===t){return""}if(e.startsWith(t)&&e[t.length]==="#"&&!e.includes("@",t.length)){return e.slice(t.length+1)}}function fe(e){var t=le(e,ee);return t!==undefined?t:le(e,Z)}function ce(e,t){return t.some(function(t){return e==="$ReturnType"?t.$ReturnType:t.$Parameter&&t.$Parameter.some(function(t){return t.$Name===e})})}function de(e){return e.slice(0,e.lastIndexOf(".")+1)}oe=p.extend("sap.ui.model.odata.v4.ODataMetaContextBinding",{constructor:function(e,t,n){i(!n||n.getModel()===e,"oContext must belong to this model");p.call(this,e,t,n)},initialize:function(){var e=this.oModel.createBindingContext(this.sPath,this.oContext);this.bInitial=false;if(e!==this.oElementContext){this.oElementContext=e;this._fireChange()}},setContext:function(e){i(!e||e.getModel()===this.oModel,"oContext must belong to this model");if(e!==this.oContext){this.oContext=e;if(!this.bInitial){this.initialize()}}}});se=c.extend("sap.ui.model.odata.v4.ODataMetaListBinding",{constructor:function(){c.apply(this,arguments)},_fireFilter:function(){},_fireSort:function(){},checkUpdate:function(e){var t=this.oList.length;this.update();if(e||this.oList.length!==t){this._fireChange({reason:f.Change})}},fetchContexts:function(){var e,t=this.getResolvedPath(),n=this;if(!t){return u.resolve([])}e=t.endsWith("@");if(!e&&!t.endsWith("/")){t+="/"}return this.oModel.fetchObject(t).then(function(i){if(!i){return[]}if(e){t=t.slice(0,-1)}return Object.keys(i).filter(function(t){return t[0]!=="$"&&e!==(t[0]!=="@")}).map(function(e){return new d(n.oModel,t+e)})})},getContexts:function(e,t){this.iCurrentStart=e||0;this.iCurrentLength=Math.min(t||Infinity,this.iLength-this.iCurrentStart);return this.getCurrentContexts()},getCurrentContexts:function(){var e=[],t,n=this.iCurrentStart+this.iCurrentLength;for(t=this.iCurrentStart;t<n;t+=1){e.push(this.oList[this.aIndices[t]])}if(this.oList.dataRequested){e.dataRequested=true}return e},setContexts:function(e){this.oList=e;this.updateIndices();this.applyFilter();this.applySort();this.iLength=this._getLength()},update:function(){var e=[],t=this.fetchContexts(),n=this;if(t.isFulfilled()){e=t.getResult()}else{t.then(function(e){n.setContexts(e);n._fireChange({reason:f.Change})});e.dataRequested=true}this.setContexts(e)}});ue=y.extend("sap.ui.model.odata.v4.ODataMetaPropertyBinding",{constructor:function(){y.apply(this,arguments);this.vValue=undefined},checkUpdate:function(e,t){var n,i=this;function r(n){if(e||n!==i.vValue){i.vValue=n;i._fireChange({reason:t||f.Change})}return n}n=this.oModel.fetchObject(this.sPath,this.oContext,this.mParameters).then(r);if(this.mParameters&&this.mParameters.$$valueAsPromise&&n.isPending()){r(n.unwrap())}else if(n.isRejected()){n.unwrap()}},getValue:function(){return this.vValue},setContext:function(e){if(this.oContext!==e){this.oContext=e;if(this.bRelative){this.checkUpdate(false,f.Context)}}},setValue:function(){throw new Error("Unsupported operation: ODataMetaPropertyBinding#setValue")}});function pe(e,t,n,i,r,o){h.call(this);this.aAnnotationUris=n&&!Array.isArray(n)?[n]:n;this.sDefaultBindingMode=l.OneTime;this.mETags={};this.sForbiddenSchema=undefined;this.sLanguage=o;this.oLastModified=new Date(0);this.oMetadataPromise=null;this.oMetaModelForAnnotations=null;this.oModel=i;this.mMetadataUrl2Promise={};this.oRequestor=e;this.mSchema2MetadataUrl={};this.mSharedModelByUrl={};this.mSupportedBindingModes={OneTime:true,OneWay:true};this.bSupportReferences=r!==false;this.mUnsupportedFilterOperators={All:true,Any:true};this.sUrl=t}ae.prototype.$$valueAsPromise=true;ae.prototype._addUrlForSchema=function(e,t,n){var i,r=this.mSchema2MetadataUrl[e];if(!r){r=this.mSchema2MetadataUrl[e]={};r[t]=false}else if(!(t in r)){i=Object.keys(r)[0];if(r[i]){this._reportAndThrowError("A schema cannot span more than one document: "+e+" - expected reference URI "+i+" but instead saw "+t,n)}r[t]=false}};ae.prototype._changeAnnotations=function(e){if(this.oMetaModelForAnnotations){Object.keys(e).forEach(t=>{if(e[t].$kind==="Schema"){this._doMergeAnnotations({$Annotations:this.oMetaModelForAnnotations._getAnnotationsForSchema(t)},e.$Annotations,true)}})}this.aAnnotationChanges?.forEach(({path:t,value:n})=>{const i=t.indexOf("@");const r=this.getObject(t.slice(0,i)+"@$ui5.target");if(r){e.$Annotations[r]??={};e.$Annotations[r][t.slice(i)]=n}})};ae.prototype._copyAnnotations=function(e){if(this.aAnnotationUris){throw new Error("Must not copy annotations when there are local annotation files")}this.oMetaModelForAnnotations=e};ae.prototype._doMergeAnnotations=function(e,t,n){let i=false;function r(e,t){for(const r in t){if(n||!(r in e)){e[r]=t[r];i=true}}}for(const n in e.$Annotations){t[n]??={};r(t[n],e.$Annotations[n])}delete e.$Annotations;return i};ae.prototype._getAnnotationsForSchema=function(e){const t={};const n=this.fetchEntityContainer().getResult();Object.keys(n.$Annotations).forEach(i=>{if(i.startsWith(e)){t[i]=n.$Annotations[i]}});return t};ae.prototype._getOrFetchSchema=function(e,t,n){var i,r,o,a,s=this;function l(i){if(!(t in i)){n(re,r," does not contain ",t);return}n(V,"Including ",t," from ",r);let o=false;for(const n in i){if(n[0]!=="$"&&de(n)===t){e[n]=i[n];if(s._doMergeAnnotations(e[n],e.$Annotations)){o=true}}}if(o){s._changeAnnotations(e)}}if(t in e){return e[t]}a=this.mSchema2MetadataUrl[t];if(a){o=Object.keys(a);if(o.length>1){this._reportAndThrowError("A schema cannot span more than one document: "+"schema is referenced by following URLs: "+o.join(", "),t)}r=o[0];a[r]=true;n(V,"Namespace ",t," found in $Include of ",r);i=this.mMetadataUrl2Promise[r];if(!i){n(V,"Reading ",r);i=this.mMetadataUrl2Promise[r]=u.resolve(this.oRequestor.read(r)).then(this.validate.bind(this,r))}i=i.then(l);if(t in e){return e[t]}e[t]=i;return i}};ae.prototype._mergeAnnotations=function(e,t){var n=this;this.validate(this.sUrl,e);e.$Annotations={};Object.keys(e).forEach(function(t){if(e[t].$kind==="Schema"){n._addUrlForSchema(t,n.sUrl);n._doMergeAnnotations(e[t],e.$Annotations)}});t.forEach(function(t,i){var r,o;n.validate(n.aAnnotationUris[i],t);for(o in t){if(o[0]!=="$"){if(o in e){n._reportAndThrowError("A schema cannot span more than one document: "+o,n.aAnnotationUris[i])}r=t[o];e[o]=r;if(r.$kind==="Schema"){n._addUrlForSchema(o,n.aAnnotationUris[i]);n._doMergeAnnotations(r,e.$Annotations,true)}}}})};ae.prototype._reportAndThrowError=function(e,t){var n=new Error(t+": "+e);this.oModel.reportError(e,K,n);throw n};ae.prototype._setForbiddenSchema=function(e){this.sForbiddenSchema=e};ae.prototype.attachEvent=function(e,t,n,i){if(!(e in J)){throw new Error("Unsupported event '"+e+"': v4.ODataMetaModel#attachEvent")}return h.prototype.attachEvent.apply(this,arguments)};ae.prototype.bindContext=function(e,t){return new oe(this,e,t)};ae.prototype.bindList=function(e,t,n,i){return new se(this,e,t,n,i)};ae.prototype.bindProperty=function(e,t,n){return new ue(this,e,t,n)};ae.prototype.bindTree=function(e,t,n,i,r){throw new Error("Unsupported operation: v4.ODataMetaModel#bindTree")};ae.prototype.destroy=function(){this.oMetaModelForAnnotations=undefined;Object.values(this.mSharedModelByUrl).forEach(e=>e.destroy());this.mSharedModelByUrl=undefined;h.prototype.destroy.apply(this)};ae.prototype.fetchCanonicalPath=function(e){return this.fetchUpdateData("",e).then(function(t){if(!t.editUrl){throw new Error(e.getPath()+": No canonical path for transient entity")}if(t.propertyPath){throw new Error("Context "+e.getPath()+" does not point to an entity. It should be "+t.entityPath)}return"/"+t.editUrl})};ae.prototype.fetchData=function(){return this.fetchEntityContainer().then(function(e){return JSON.parse(JSON.stringify(e))})};ae.prototype.fetchEntityContainer=function(e){var t,n=this;if(!this.oMetadataPromise){t=[u.resolve(this.oRequestor.read(this.sUrl,false,e))];if(this.aAnnotationUris){this.aAnnotationUris.forEach(function(i){t.push(u.resolve(n.oRequestor.read(i,true,e)))})}if(!e){t.push(this.oModel._requestAnnotationChanges());this.oMetadataPromise=u.all(t).then(function(e){var t=Object.assign(e[0],N);n.aAnnotationChanges=e.pop();n._mergeAnnotations(t,e.slice(1));return t});this.oMetadataPromise.then(e=>this._changeAnnotations(e),()=>{})}}return this.oMetadataPromise};ae.prototype.fetchObject=function(e,t,n){var i=this.resolve(e,t),s=this;if(!i){r.error("Invalid relative path w/o context",e,K);return u.resolve(null)}return this.fetchEntityContainer().then(function(l){var f,c,p,h,y,g,m,$,v,M,b;function O(e,t,n=""){var i,r,o,a,s="";if(t){r=t.indexOf("@@");if(r>0){t=t.slice(0,r)}}else{t=e}if(f){$=a=b.filter(E);if(a.length!==1){return A(re,"Expected a single overload, but found ",a.length)}if(f!==Y){s=a[0].$Parameter[0].$isCollection?"Collection("+f+")":f}o=M+"("+s+")"+n;if(l.$Annotations[o]){if(t==="@"){b=l.$Annotations[o];i=l.$Annotations[M+n];if(i){b=Object.assign({},i,b)}return false}if(t in l.$Annotations[o]){M=o;b=l;return true}}}M+=n;b=l;return true}function C(e,t){var i,r,u,l=e.indexOf("@",2);if(l>-1){return A(re,"Unsupported path after ",e.slice(0,l))}e=e.slice(2);u=e.indexOf("(");if(u>0){if(!e.endsWith(")")){return A(re,"Expected ')' instead of '",e.slice(-1),"'")}try{r=o.parseJS("["+e.slice(u+1,-1).replace(G,"{").replace(Q,"}")+"]")}catch(e){return A(re,e.message,": ",e.text.slice(1,e.at),"<--",e.text.slice(e.at,-1))}e=e.slice(0,u)}i=e[0]==="."?a.get(e.slice(1),n.scope):n&&a.get(e,n.scope)||(e==="requestCurrencyCodes"||e==="requestUnitsOfMeasure"?s[e].bind(s):a.get(e));if(typeof i!=="function"){return A(re,e," is not a function but: "+i)}try{b=i(b,{$$valueAsPromise:n&&n.$$valueAsPromise,arguments:r,context:new d(s,t),schemaChildName:v,overload:$.length===1?$[0]:undefined})}catch(t){A(re,"Error calling ",e,": ",t)}return true}function P(e,t){var n;if(e==="$ReturnType"){if(t.$ReturnType){b=t.$ReturnType;return true}}else if(e&&t.$Parameter){n=t.$Parameter.filter(function(t){return t.$Name===e});if(n.length){b=n[0];return true}}return false}function E(e){return!e.$IsBound&&f===Y||e.$IsBound&&f===e.$Parameter[0].$Type}function A(e){var t;if(r.isLoggable(e,K)){t=Array.isArray(h)?h.join("/"):h;r[e===V?"debug":"warning"](Array.prototype.slice.call(arguments,1).join("")+(t?" at /"+t:""),i,K)}if(e===re){b=undefined}return false}function w(e,t){var n;function r(){h??=M&&t&&M+"/"+t;return A.apply(this,arguments)}f=b&&b.$Type||f;if(s.bSupportReferences&&!(e in l)){if(i.endsWith("@$ui5.target")){b=undefined;return false}n=de(e);if(n===s.sForbiddenSchema){return r(re,"Must not access schema '",n,"' from meta model for ",s.sUrl)}b=s._getOrFetchSchema(l,n,r)}if(e in l){M=y=v=e;b=$=l[v];if(!u.isThenable(b)){m=b.$OpenType;return true}}if(u.isThenable(b)&&b.isPending()){return r(V,"Waiting for ",n)}return r(re,"Unknown qualified name ",e)}function S(e,t,n){var i,r,o;if(e==="$Annotations"){return A(re,"Invalid segment: $Annotations")}e=e.replaceAll("%2F","/");if(t&&typeof b==="object"&&e in b){if(e[0]==="$"||W.test(e)){g=false}}else{i=e.indexOf("@@");if(i<0){if(e.endsWith("@sapui.name")){i=e.length-11}else{i=e.indexOf("@")}}if(i>0){if(!S(e.slice(0,i),t,n)){return false}e=e.slice(i);o=true;if(b&&(b.$kind==="EntitySet"||b.$kind==="Singleton")){c=b}}if(typeof b==="string"&&!(o&&(e==="@sapui.name"||e[1]==="@"))&&!(g&&$&&$.$kind==="EnumType")&&!U(b,n.slice(0,t))){return false}if(g){if(e[0]==="$"&&e!=="$Parameter"&&e!=="$ReturnType"||W.test(e)){g=false}else{r=typeof b==="object";if(o){}else if(e[0]!=="@"&&e.includes(".",1)){return w(e)}else if(r&&"$Type"in b){if(m&&b.$Type==="Edm.Untyped"){y=undefined}else if(!w(b.$Type,"$Type")){return false}}else if(r&&"$Action"in b){if(!w(b.$Action,"$Action")){return false}f=Y}else if(r&&"$Function"in b){if(!w(b.$Function,"$Function")){return false}f=Y}else if(!t){M=y=v??=l.$EntityContainer;b=$??=l[v];if(Array.isArray(b)){if(f){b=b.filter(E)}if(P(e,b[0])){return true}}if(e&&e[0]!=="@"&&!(e in $)){return A(re,"Unknown child ",e," of ",v)}}if(Array.isArray(b)){if(e==="$Parameter"){return true}if(e.startsWith("@$ui5.overload@")){e=e.slice(14);o=true}if(o){if(e[1]!=="@"&&!O(e)){return false}}else{if(e!==n[t]&&n[t][e.length+1]!=="@"&&ce(e,b)){y=e;return O(e,n[t].slice(e.length),"/"+y)}if(f){b=b.filter(E)}if(e==="@$ui5.overload"){return true}if(b.length!==1){return A(re,"Expected a single overload, but found "+b.length)}if(P(e,b[0])){return true}b=b[0].$ReturnType;M+="/0/$ReturnType";if(b){if(e==="value"&&!(l[b.$Type]&&l[b.$Type].value)){y=undefined;return true}if(!w(b.$Type,"$Type")){return false}}if(!e){return true}}}}}if(!e){return t+1>=n.length||A(re,"Invalid empty segment")}if(e[0]==="@"){function a(i){b=i;if(b===undefined){A(re,"Unsupported path before ",e)}else if(t+1<n.length){A(re,"Unsupported path after ",e)}return false}if(e==="@sapui.name"){if(y===undefined&&o&&t&&n[t-1]==="$NavigationPropertyBinding"){y=b}return a(y)}if(e==="@$ui5.target"){return a(M)}if(e[1]==="@"){if(t+1<n.length){return A(re,"Unsupported path after ",e)}return C(e,[""].concat(n.slice(0,t),n[t].slice(0,i)).join("/"))}}if(g&&e[0]==="@"){f=b&&b.$Type||f;b=l.$Annotations[M]||{};g=false}else if(e==="$"&&t+1<n.length){return A(re,"Unsupported path after $")}else if(!b||typeof b!=="object"){b=undefined;return!p&&A(V,"Invalid segment: ",e)}}if(e!=="@"&&e!=="$"){if(e[0]==="@"){p=true}y=g||e[0]==="@"?e:undefined;M=g?M+"/"+e:undefined;b=m&&!p&&!(e in b)?q:b[e]}return true}function U(e,t){var n;if(h){return A(re,"Invalid recursion")}h=t;p=false;g=true;b=l;if(c){if(!e){b=c;c=h=undefined;return true}v=c.$Type;c=$=undefined}n=e.split("/").every(S);h=undefined;return n}if(!U(i.slice(1))&&u.isThenable(b)){b=b.then(function(){return s.fetchObject(e,t,n)})}return b})};ae.prototype.fetchUI5Type=function(e,t){const i=e.slice(e.lastIndexOf("/")+1);if(i[0]==="$"||i[0]==="@"){if(_.includes(i)){F??=new A;return u.resolve(F)}if(i.startsWith("@$ui5.context.is")||i.startsWith("@$ui5.node.is")){D??=new m;return u.resolve(D)}}const o=this.getMetaContext(e);return this.fetchObject(undefined,o).catch(this.oModel.getReporter()).then(a=>{var s=H,u;if(!a){r.warning("No metadata for path '"+e+"', using "+s.getName(),undefined,K);return s}if(t){if(n.isEmptyObject(t)){t=undefined}else if("parseKeepsEmptyString"in t&&a.$Type!=="Edm.String"){if(Object.keys(t).length===1){t=undefined}else{t=Object.assign({},t);delete t.parseKeepsEmptyString}}}if(!t&&a["$ui5.type"]){return a["$ui5.type"]}if(a.$isCollection&&!W.test(i)){r.warning("Unsupported collection type, using "+s.getName(),e,K)}else{u=X[a.$Type];if(u){s=new u.Type(t,this.getConstraints(a,o.getPath()))}else{r.warning("Unsupported type '"+a.$Type+"', using "+s.getName(),e,K)}}if(!t){a["$ui5.type"]=s}return s})};ae.prototype.fetchUpdateData=function(e,t,i){var r=t.getModel(),o=r.resolve(e,t),a=this;function s(e){var t=new Error(o+": "+e);if(i!==undefined){r.reportError(e,K,t)}throw t}return this.fetchObject(n.getMetaPath(o)).then(function(){return a.fetchEntityContainer()}).then(function(r){var a,l=r[r.$EntityContainer],f,c,d,p,h=false,y,g,m,$=false,v,M=false;function b(e){var t=e.indexOf("(");return t>=0?e.slice(t):""}function O(e){a.push({path:y,prefix:e})}function C(e){var t=e.indexOf("(");return t>=0?e.slice(0,t):e}m=o.slice(1).split("/");p=m.shift();y="/"+p;f=y;d=decodeURIComponent(C(p));c=l[d];if(!c){s("Not an entity set: "+d)}v=r[c.$Type];e="";g="";a=[p];$=p.includes("($uid=");m.forEach(function(t){var i,o;y+="/"+t;if(W.test(t)){O(a.pop());f+="/"+t}else{o=decodeURIComponent(C(t));g=n.buildPath(g,o);i=h?{}:v[o];if(!i){if(o.includes("@")||v.$OpenType){if(o.includes("@$ui5.")&&o!=="@$ui5.context.isSelected"){s("Read-only path must not be updated")}h=true;i={}}else{s("Not a (navigation) property: "+o)}}v=r[i.$Type];if(t.includes("($uid=")){f=y;e="";$=true}else if(!$&&i.$kind==="NavigationProperty"){if(c.$NavigationPropertyBinding&&g in c.$NavigationPropertyBinding){d=c.$NavigationPropertyBinding[g];c=l[d];g="";a=[encodeURIComponent(d)+b(t)];if(!i.$isCollection){O(a.pop())}}else{a.push(t)}f=y;e=""}else{e=n.buildPath(e,t)}}});if($||i){return u.resolve({editUrl:undefined,entityPath:f,propertyPath:e})}return u.all(a.map(function(e,r){if(typeof e==="string"){return e}return t.fetchValue(e.path).then(function(t){var o;if(i!==undefined&&r===a.length-1&&(t===null||t&&n.hasPrivateAnnotation(t,"upsert"))){M=true;return undefined}if(!t){s("No instance to calculate key predicate at "+e.path)}o=n.getPrivateAnnotation(t,"predicate");if(!o){s("No key predicate known at "+e.path)}return e.prefix+o},function(t){s(t.message+" at "+e.path)})})).then(function(t){return{editUrl:M?f.slice(1):t.join("/"),entityPath:f,propertyPath:e}})})};ae.prototype.fetchValueListMappings=function(e,t,i,r){var o=this,a=e.getMetaModel();function s(){var e=r[0],n="";if(r.length!==1){throw new Error("Expected a single overload, but found "+r.length)}if(e.$IsBound){n=e.$Parameter[0].$isCollection?"Collection("+e.$Parameter[0].$Type+")":e.$Parameter[0].$Type}return t+"("+n+")"}return a.fetchEntityContainer().then(function(r){var u,l=r.$Annotations,f,c=n.namespace(t),d={},p=o===a,h,y;if(i.$Name){f=s()+"/"+i.$Name;y=t+"/"+i.$Name}h=Object.keys(l).filter(function(t){if(n.namespace(t)===c){if(f?t===f||t===y:o.getObject("/"+t)===i){return true}if(p||y&&n.getMetaPath(t)===y){return false}throw new Error("Unexpected annotation target '"+t+"' with namespace of data service in "+e.sServiceUrl)}return false});if(!h.length){throw new Error("No annotation '"+Z.slice(1)+"' in "+e.sServiceUrl)}if(h.length===1){u=l[h[0]]}else{u=Object.assign({},l[y],l[f])}Object.keys(u).forEach(function(t){var n=fe(t);if(n!==undefined){d[n]=u[t];["CollectionRoot","SearchSupported"].forEach(function(n){if(n in u[t]){throw new Error("Property '"+n+"' is not allowed in annotation '"+t.slice(1)+"' for target '"+h[0]+"' in "+e.sServiceUrl)}})}else if(!p){throw new Error("Unexpected annotation '"+t.slice(1)+"' for target '"+h[0]+"' with namespace of data service in "+e.sServiceUrl)}});return d})};ae.prototype.fetchValueListType=function(e){var n=this.getMetaContext(e),i=this;return this.fetchObject(undefined,n).then(function(r){var o,a;if(!r){throw new Error("No metadata for "+e)}o=i.getObject("@",n);if(o[ie]){return t.Fixed}for(a in o){if(le(a,te)!==undefined||le(a,ee)!==undefined){return t.Standard}if(le(a,Z)!==undefined){return o[a].SearchSupported===false?t.Fixed:t.Standard}}return t.None})};ae.prototype.filterValueListRelevantQualifiers=function(e,t,n,i){return this.requestValue4Annotation(t,n,i).then(function(t){var n={};t.forEach(function(t){if(t in e){n[t]=e[t]}});return n})};ae.prototype.getAbsoluteServiceUrl=function(e){var t=new L(this.sUrl).absoluteTo(document.baseURI).pathname().toString();return new L(e).absoluteTo(t).filename("").toString()};ae.prototype.getAllPathReductions=function(e,t,i,r){var o=t.split("/").length,a,s={},u=e.split("/"),l=this;function f(e,t,a,u){var c,d,p;function h(n){if(!i){f(e,t,p-1,true)}if(u){t=t.slice();e=e.slice()}t.splice(p,n);e.splice(p,n);if(!i){s[e.join("/")]=true}}for(p=a;p>=o;p-=1){c=W.test(e[p+1])?p+2:p+1;if(c<e.length&&t[p].$Partner===e[c]&&!t[c].$isCollection&&t[c].$Partner===e[p].replace(z,"")){h(c-p+1)}else if(Array.isArray(t[p])&&e[p+1]==="$Parameter"){d=l.getObject(n.getMetaPath(e.slice(0,p+1).join("/")+"/@$ui5.overload"));if(d.length===1&&d[0].$Parameter[0].$Name===e[p+2]){h(3)}}else if(r&&t[p].$isCollection){break}}}a=u.map(function(e,t){return t<o||e[0]==="#"||e[0]==="@"||W.test(e)||e==="$Parameter"?{}:l.getObject(n.getMetaPath(u.slice(0,t+1).join("/")))||{}});s[e]=true;if(!(r&&a[u.length-1].$isCollection)){f(u,a,u.length-2)}return i?u.join("/"):Object.keys(s)};ae.prototype.getConstraints=function(e,t){var n,i,r,o=X[e.$Type];function a(e,t){if(t!==undefined){i??={};i[e]=t}}if(o){r=o.constraints;for(n in r){a(r[n],n[0]==="@"?this.getObject(t+n):e[n])}if(e.$Nullable===false){a("nullable",false)}if(e.$Type==="Edm.DateTimeOffset"){a("V4",true)}}return i};ae.prototype.getData=n.createGetMethod("fetchData");ae.prototype.getETags=function(){return this.mETags};ae.prototype.getLastModified=function(){return this.oLastModified};ae.prototype.getMetaContext=function(e){return new d(this,n.getMetaPath(e))};ae.prototype.getMetaPath=function(e){return n.getMetaPath(e)};ae.prototype.getObject=n.createGetMethod("fetchObject");ae.prototype.getOrCreateSharedModel=function(e,t,n,i){e=this.getAbsoluteServiceUrl(e);const r=!!n+e;let o=this.mSharedModelByUrl;if(!t){o??={}}let a=o[r];if(!a){a=new this.oModel.constructor({autoExpandSelect:n,groupId:t?undefined:"$direct",httpHeaders:this.oModel.getHttpHeaders(),metadataUrlParams:this.sLanguage&&{"sap-language":this.sLanguage},operationMode:g.Server,serviceUrl:e,sharedRequests:true});if(t){a.getMetaModel()._copyAnnotations(this.oMetaModelForAnnotations??this)}if(i){a.getMetaModel()._setForbiddenSchema(de(i))}a.setRetryAfterHandler(e=>this.oModel.getOrCreateRetryAfterPromise(e));o[r]=a}return a};ae.prototype.getOriginalProperty=function(){throw new Error("Unsupported operation: v4.ODataMetaModel#getOriginalProperty")};ae.prototype.getProperty=ae.prototype.getObject;ae.prototype.getReducedPath=function(e,t){return this.getAllPathReductions(e,t,true,true)};ae.prototype.getUI5Type=n.createGetMethod("fetchUI5Type",true);ae.prototype.getUnitOrCurrencyPath=function(e){var t=this.getObject("@",this.getMetaContext(e)),n=t&&(t["@Org.OData.Measures.V1.Unit"]||t["@Org.OData.Measures.V1.ISOCurrency"]);return n&&n.$Path};ae.prototype.getValueListType=n.createGetMethod("fetchValueListType",true);ae.prototype.isAddressViaNavigationPath=function(){return this.getObject("/@com.sap.vocabularies.Common.v1.AddressViaNavigationPath")};ae.prototype.isList=function(){throw new Error("Unsupported operation: v4.ODataMetaModel#isList")};ae.prototype.refresh=function(){throw new Error("Unsupported operation: v4.ODataMetaModel#refresh")};ae.prototype.requestCodeList=function(e,t,i){var o=this.fetchEntityContainer().getResult(),a=o[o.$EntityContainer],s=this;if(i&&i.context){if(i.context.getModel()!==this||i.context.getPath()!=="/"){throw new Error("Unsupported context: "+i.context)}}if(t!==undefined&&t!==a){throw new Error("Unsupported raw value: "+t)}return this.requestObject("/@com.sap.vocabularies.CodeList.v1."+e).then(function(e){var t,i,o,a,u,l;if(!e){return null}l=s.getAbsoluteServiceUrl(n.setLanguage(e.Url,s.sLanguage));t=e.CollectionPath+"#"+l;a=I[t];if(a){return a}const f=!s.mSharedModelByUrl;o=s.getOrCreateSharedModel(l);i=o.getMetaModel();u="/"+e.CollectionPath+"/";a=i.requestObject(u).then(function(t){var n=u+"@Org.OData.Core.V1.AlternateKeys",a=i.getObject(n),s,l=$(t.$Key),c=u+l+"@com.sap.vocabularies.Common.v1.",d,p,h=u+l+"@com.sap.vocabularies.CodeList.v1.StandardCode/$Path",y,g;function m(t,n){var i=n.getProperty(l),o={Text:n.getProperty(g),UnitSpecificScale:n.getProperty(p)};if(y){o.StandardCode=n.getProperty(y)}if(o.UnitSpecificScale===null){r.error("Ignoring customizing w/o unit-specific scale for code "+i+" from "+e.CollectionPath,e.Url,K)}else{t[i]=o}return t}function $(e){var t;if(e&&e.length===1){t=e[0]}else{throw new Error("Single key expected: "+u)}return typeof t==="string"?t:t[Object.keys(t)[0]]}if(a){if(a.length!==1){throw new Error("Single alternative expected: "+n)}else if(a[0].Key.length!==1){throw new Error("Single key expected: "+n+"/0/Key")}l=a[0].Key[0].Name.$PropertyPath}p=i.getObject(c+"UnitSpecificScale/$Path");g=i.getObject(c+"Text/$Path");d=[l,p,g];y=i.getObject(h);if(y){d.push(y)}s=o.bindList("/"+e.CollectionPath,null,null,null,{$select:d});return s.requestContexts(0,Infinity).then(function(t){if(!t.length){r.error("Customizing empty for ",o.sServiceUrl+e.CollectionPath,K)}return t.reduce(m,{})}).finally(function(){s.destroy();if(f){o.destroy()}})});I[t]=a;return a})};ae.prototype.requestCurrencyCodes=function(e,t){return this.requestCodeList("CurrencyCodes",e,t)};ae.prototype.requestData=n.createRequestMethod("fetchData");ae.prototype.requestObject=n.createRequestMethod("fetchObject");ae.prototype.requestUI5Type=n.createRequestMethod("fetchUI5Type");ae.prototype.requestUnitsOfMeasure=function(e,t){return this.requestCodeList("UnitsOfMeasure",e,t)};ae.prototype.requestValue4Annotation=function(t,i,r){let o;const a=n.getMetaPath(r.getPath());const s=i.indexOf("/",a.length+1);if(s>0){const e=this.getObject(i.slice(0,s)+"/$Partner");if(e){o={$IsBound:true,$Parameter:[{$Name:e}]}}}const u=new R({any:e.value(t,{context:this.createBindingContext(i),overload:o}),bindingContexts:r,models:r.getModel()});const l=u.getBinding("any");let f;if(l){if(l.getBindings){f=Promise.all(l.getBindings().map(function(e){return e.requestValue()}))}else{f=l.requestValue()}}else{f=Promise.resolve()}return f.then(function(){return u.getAny()})};ae.prototype.requestValueListInfo=function(e,t,i){var r=n.getMetaPath(e),o=r.slice(0,r.lastIndexOf("/")).replace("/$Parameter",""),a=o.slice(o.lastIndexOf("/")+1),s=this;if(!a.includes(".")){a=undefined}return Promise.all([a||this.requestObject(o+"/@sapui.name"),this.requestObject(r),this.requestObject(r+"@"),this.requestObject(r+ie),this.requestObject(o+"/@$ui5.overload")]).then(function([o,a,u,l,f]){var c={},d={};function p(i,r,a,u){if("CollectionRoot"in i){u=s.getOrCreateSharedModel(i.CollectionRoot,true,t,o);if(d[r]&&d[r].$model===u){c[r]=undefined}}if(c[r]){throw new Error("Annotations '"+Z.slice(1)+"' with identical qualifier '"+r+"' for property "+e+" in "+c[r]+" and "+a)}c[r]=a;i=n.clone(i);i.$model=u;delete i.CollectionRoot;delete i.SearchSupported;d[r]=i}if(!a){throw new Error("No metadata for "+e)}return Promise.all(Object.keys(u).filter(function(e){return le(e,te)!==undefined}).map(function(e){var n=u[e];return Promise.all(n.map(function(e){var n=s.getOrCreateSharedModel(e,true,t,o);return s.fetchValueListMappings(n,o,a,f).then(function(e){return{valueListMappingByQualifier:e,$model:n}})})).then(function(e){n.forEach(function(t,n){var i=e[n].valueListMappingByQualifier;Object.keys(i).forEach(function(r){p(i[r],r,t,e[n].$model)})})})})).then(function(){var t=u[ne];Object.keys(u).filter(function(e){return fe(e)!==undefined}).forEach(function(e){p(u[e],fe(e),s.sUrl,s.oModel)});if(n.isEmptyObject(d)){throw new Error("No annotation '"+te.slice(1)+"' for "+e)}return t&&i&&i.getBinding?s.filterValueListRelevantQualifiers(d,t,r+ne,i):d}).then(function(t){var n,i;if(l){n=Object.keys(t);if(n.length!==1){throw new Error("Annotation '"+ie.slice(1)+"' but not exactly one '"+Z.slice(1)+"' for property "+e)}i=t[n[0]];i.$qualifier=n[0];return{"":i}}return t})})};ae.prototype.requestValueListType=n.createRequestMethod("fetchValueListType");ae.prototype.resolve=function(e,t){var n,i;if(!e){return t?t.getPath():undefined}i=e[0];if(i==="/"){return e}if(!t){return undefined}if(i==="."){if(e[1]!=="/"){throw new Error("Unsupported relative path: "+e)}e=e.slice(2)}n=t.getPath();return i==="@"||n.endsWith("/")?n+e:n+"/"+e};ae.prototype.setLegacySyntax=function(){throw new Error("Unsupported operation: v4.ODataMetaModel#setLegacySyntax")};ae.prototype.toString=function(){return K+": "+this.sUrl};ae.prototype.validate=function(e,t){var n,i,r,o,a,s;if(!this.bSupportReferences){return t}for(a in t.$Reference){o=t.$Reference[a];a=new L(a).absoluteTo(this.sUrl).toString();if("$IncludeAnnotations"in o){this._reportAndThrowError("Unsupported IncludeAnnotations",e)}for(s in o.$Include){r=o.$Include[s];if(r in t){this._reportAndThrowError("A schema cannot span more than one document: "+r+" - is both included and defined",e)}this._addUrlForSchema(r,a,e)}}i=t.$LastModified?new Date(t.$LastModified):null;this.mETags[e]=t.$ETag?t.$ETag:i;n=t.$Date?new Date(t.$Date):new Date;i??=n;if(this.oLastModified<i){this.oLastModified=i}delete t.$Date;delete t.$ETag;delete t.$LastModified;return t};ae.clearCodeListsCache=function(){I={}};Object.keys(N).forEach(e=>{const t=e.replace("Geography","Geometry");N[t]=N[e]});return ae});
//# sourceMappingURL=ODataMetaModel.js.map