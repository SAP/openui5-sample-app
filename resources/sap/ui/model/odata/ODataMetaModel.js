/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_ODataMetaModelUtils","sap/base/Log","sap/base/util/isEmptyObject","sap/ui/base/BindingParser","sap/ui/base/ManagedObject","sap/ui/base/SyncPromise","sap/ui/model/_Helper","sap/ui/model/BindingMode","sap/ui/model/ClientContextBinding","sap/ui/model/Context","sap/ui/model/FilterProcessor","sap/ui/model/MetaModel","sap/ui/model/json/JSONListBinding","sap/ui/model/json/JSONModel","sap/ui/model/json/JSONPropertyBinding","sap/ui/model/json/JSONTreeBinding"],function(e,t,n,o,i,r,a,s,d,l,c,u,p,h,f,y){"use strict";var g=new Map,m="sap.ui.model.odata.ODataMetaModel",C=/^((\/dataServices\/schema\/\d+)\/(?:complexType|entityType)\/\d+)\/property\/\d+$/;const O=/^(((\/dataServices\/schema\/\d+)\/entityContainer\/\d+)\/functionImport\/\d+)\/parameter\/\d+$/;var M=p.extend("sap.ui.model.odata.ODataMetaListBinding"),v=i.extend("sap.ui.model.odata._resolver",{metadata:{properties:{any:"any"}}});M.prototype.applyFilter=function(){var e=this,t=c.combineFilters(this.aFilters,this.aApplicationFilters);this.aIndices=c.apply(this.aIndices,t,function(t,n){return n==="@sapui.name"?t:e.oModel.getProperty(n,e.oList[t])},this.mNormalizeCache);this.iLength=this.aIndices.length};var b=u.extend("sap.ui.model.odata.ODataMetaModel",{constructor:function(t,n,o){var i=o.annotationsLoaded(),d=this;function l(){var i;if(d.bDestroyed){throw new Error("Meta model already destroyed")}i=JSON.parse(JSON.stringify(t.getServiceMetadata()));d.oModel=new h(i);d.oModel.setDefaultBindingMode(d.sDefaultBindingMode);if(!o._requestAnnotationChanges){e.merge(n?n.getData():{},i,d,o.bIgnoreAnnotationsFromMetadata);return undefined}return o._requestAnnotationChanges().then(t=>{e.merge(n?n.getData():{},i,d,o.bIgnoreAnnotationsFromMetadata);d.aAnnotationChanges=a.deepClone(t,20);d._applyAnnotationChanges()})}u.apply(this);this.oModel=null;this.mContext2Promise={};this.sDefaultBindingMode=s.OneTime;this.oLoadedPromise=i?i.then(l):new Promise(function(e){l();e()});this.oLoadedPromiseSync=r.resolve(this.oLoadedPromise);this.oMetadata=t;this.oDataModel=o;this.mQueryCache={};this.mQName2PendingRequest={};this.oResolver=undefined;this.mSupportedBindingModes={OneTime:true}}});b.prototype._applyAnnotationChanges=function(){if(!this.aAnnotationChanges){return}const e=[];this.aAnnotationChanges.forEach(t=>{const n=this._getObject(t.path,undefined,true);if(n){this.oModel.setProperty(n,t.value)}else{e.push(t)}});this.aAnnotationChanges=e.length?e:undefined};b.prototype._getObject=function(e,n,i){var r=n,a,s,d,c,u,p,h,f=e||"",y;if(!n||n instanceof l){f=this.resolve(e||"",n);if(!f){t.error("Invalid relative path w/o context",e,m);return null}}if(f.charAt(0)==="/"){r=this.oModel._getObject("/");f=f.slice(1)}h="/";u=r;while(f){p=undefined;a=undefined;if(f.charAt(0)==="["){try{y=o.parseExpression(f,1);c=y.at;if(f.length===c+1||f.charAt(c+1)==="/"){a=y.result;p=f.slice(0,c+1);f=f.slice(c+2)}}catch(e){if(!(e instanceof SyntaxError)){throw e}}}if(p===undefined){c=f.indexOf("/");if(c<0){p=f;f=""}else{p=f.slice(0,c);f=f.slice(c+1)}}if(!u){if(i){return null}if(t.isLoggable(t.Level.WARNING,m)){t.warning("Invalid part: "+p,"path: "+e+", context: "+(n instanceof l?n.getPath():n),m)}break}if(a){if(r===n){t.error("A query is not allowed when an object context has been given",e,m);return null}if(!Array.isArray(u)){t.error("Invalid query: '"+h+"' does not point to an array",e,m);return null}s=h+p;p=this.mQueryCache[s];if(p===undefined){this.oResolver=this.oResolver||new v({models:this.oModel});for(d=0;d<u.length;d+=1){this.oResolver.bindObject(h+d);this.oResolver.bindProperty("any",a);try{if(this.oResolver.getAny()){this.mQueryCache[s]=p=d;break}}finally{this.oResolver.unbindProperty("any");this.oResolver.unbindObject()}}}}u=u[p];h=h+p+"/"}return i?h:u};b.prototype._getOrCreateSharedModelCache=function(){var e=this.oDataModel;if(!this.oSharedModelCache){this.oSharedModelCache={bFirstCodeListRequested:false,oModel:new e.constructor(e.getCodeListModelParameters())}}return this.oSharedModelCache};b.prototype._mergeMetadata=function(t){var n=this.getODataEntityContainer(),o=e.getChildAnnotations(t.annotations,n.namespace+"."+n.name,true),i=n.entitySet.length,r=this.oModel.getObject("/dataServices/schema"),a=this;t.entitySets.forEach(function(o){var i,s,d=o.entityType,l=d.slice(0,d.lastIndexOf("."));if(!a.getODataEntitySet(o.name)){n.entitySet.push(JSON.parse(JSON.stringify(o)));if(!a.getODataEntityType(d)){i=a.oMetadata._getEntityTypeByName(d);s=e.getSchema(r,l);s.entityType.push(JSON.parse(JSON.stringify(i)));e.visitParents(s,t.annotations,"entityType",e.visitEntityType,s.entityType.length-1)}}});e.visitChildren(n.entitySet,o,"EntitySet",r,null,i);e.addUnitAnnotations(r,this)};b.prototype._sendBundledRequest=function(){var e=this.mQName2PendingRequest,t=Object.keys(e),n=this;if(!t.length){return}this.mQName2PendingRequest={};t=t.sort();t.forEach(function(e,n){t[n]=encodeURIComponent(e)});this.oDataModel.addAnnotationUrl("$metadata?sap-value-list="+t.join(",")).then(function(t){var o;n._mergeMetadata(t);for(o in e){try{e[o].resolve(t)}catch(t){e[o].reject(t)}}n._applyAnnotationChanges()},function(t){var n;for(n in e){e[n].reject(t)}})};b.prototype.bindContext=function(e,t,n){return new d(this,e,t,n)};b.prototype.bindList=function(e,t,n,o,i){return new M(this,e,t,n,o,i)};b.prototype.bindProperty=function(e,t,n){return new f(this,e,t,n)};b.prototype.bindTree=function(e,t,n,o){return new y(this,e,t,n,o)};b.prototype.destroy=function(){u.prototype.destroy.apply(this,arguments);if(this.oSharedModelCache){this.oSharedModelCache.oModel.destroy();delete this.oSharedModelCache}return this.oModel&&this.oModel.destroy.apply(this.oModel,arguments)};b.prototype.fetchCodeList=function(e){var n=this;return this.oLoadedPromiseSync.then(function(){var o,i,a,s,d,l,c,u,p,h="com.sap.vocabularies.CodeList.v1."+e,f=n.getODataEntityContainer()[h];if(!f||!f.Url.String){return null}if(f.Url.String!=="./$metadata"){throw new Error(h+"/Url/String has to be './$metadata' for the service "+n.oDataModel.getCodeListModelParameters().serviceUrl)}d=f.CollectionPath.String;c=n.oDataModel.getMetadataUrl();o=c+"#"+d;u=g.get(o);if(u){return u}i=o+"#"+n.getId();u=g.get(i);if(u){return u}s=n._getOrCreateSharedModelCache();a=s.oModel;p=new r(function(e,t){const n=new URL(c,"https://localhost").searchParams;const o=n.get("sap-client");const i=n.get("sap-language");const r={$skip:0,$top:5e3};if(o){r["sap-client"]=o}if(i){r["sap-language"]=i}a.read("/"+d,{error:t,success:e,urlParameters:r})});l=new r(function(e,t){try{e(n._getPropertyNamesForCodeListCustomizing(d))}catch(e){t(e)}});u=r.all([p,l]).then(function(e){var r=e[0].results,a=e[1];g.set(o,u);g.delete(i);return r.reduce(function(e,o){var i=o[a.code],r={Text:o[a.text],UnitSpecificScale:o[a.unitSpecificScale]};if(a.standardCode){r.StandardCode=o[a.standardCode]}if(r.UnitSpecificScale===null){t.error("Ignoring customizing w/o unit-specific scale for code "+i+" from "+d,n.oDataModel.getCodeListModelParameters().serviceUrl,m)}else{e[i]=r}return e},{})}).catch(function(e){if(a.bDestroyed){g.delete(o);g.delete(i)}else{t.error("Couldn't load code list: "+d+" for "+n.oDataModel.getCodeListModelParameters().serviceUrl,e,m)}throw e}).finally(function(){if(s.bFirstCodeListRequested){if(!a.bDestroyed){a.destroy()}delete n.oSharedModelCache}else{s.bFirstCodeListRequested=true}});g.set(i,u);return u})};b.prototype.getMetaContext=function(e){var t,n,o,i,r,a,s,d,l;function c(e){var t=e.indexOf("(");return t>=0?e.slice(0,t):e}if(!e){return null}d=e.split("/");if(d[0]!==""){throw new Error("Not an absolute path: "+e)}d.shift();s=c(d[0]);n=this.getODataEntitySet(s);if(n){l=n.entityType}else{i=this.getODataFunctionImport(s);if(i){if(d.length===1){r=this.getODataFunctionImport(s,true)}l=i.returnType;if(l.lastIndexOf("Collection(",0)===0){l=l.slice(11,-1)}}else{throw new Error("Entity set or function import not found: "+s)}}d.shift();while(d.length){o=this.getODataEntityType(l);if(o){a=c(d[0]);t=this.getODataAssociationEnd(o,a)}else{o=this.getODataComplexType(l)}if(t){l=t.type;if(t.multiplicity==="1"&&a!==d[0]){throw new Error("Multiplicity is 1: "+d[0])}d.shift()}else{r=this.getODataProperty(o,d,true);if(d.length){throw new Error("Property not found: "+d.join("/"))}break}}r=r||this.getODataEntityType(l,true);return this.createBindingContext(r)};b.prototype.getODataAssociationEnd=function(t,n){var o=t?e.findObject(t.navigationProperty,n):null,i=o?e.getObject(this.oModel,"association",o.relationship):null,r=i?e.findObject(i.end,o.toRole,"role"):null;return r};b.prototype.getODataAssociationSetEnd=function(t,n){var o,i=null,r=this.getODataEntityContainer(),a=t?e.findObject(t.navigationProperty,n):null;if(r&&a){o=e.findObject(r.associationSet,a.relationship,"association");i=o?e.findObject(o.end,a.toRole,"role"):null}return i};b.prototype.getODataComplexType=function(t,n){return e.getObject(this.oModel,"complexType",t,n)};b.prototype.getODataEntityContainer=function(t){var n=t?undefined:null,o=this.oModel.getObject("/dataServices/schema");if(o){o.forEach(function(o,i){var r=e.findIndex(o.entityContainer,"true","isDefaultEntityContainer");if(r>=0){n=t?"/dataServices/schema/"+i+"/entityContainer/"+r:o.entityContainer[r]}});if(!n&&o.length===1&&o[0].entityContainer&&o[0].entityContainer.length===1){n=t?"/dataServices/schema/0/entityContainer/0":o[0].entityContainer[0]}}return n};b.prototype.getODataEntitySet=function(t,n){return e.getFromContainer(this.getODataEntityContainer(),"entitySet",t,n)};b.prototype.getODataEntityType=function(t,n){return e.getObject(this.oModel,"entityType",t,n)};b.prototype.getODataFunctionImport=function(t,n){var o=t&&t.indexOf("/")>=0?t.split("/"):undefined,i=o?e.getObject(this.oModel,"entityContainer",o[0]):this.getODataEntityContainer();return e.getFromContainer(i,"functionImport",o?o[1]:t,n)};b.prototype.getFunctionImportParameterContext=function(t,n){const o=this.getODataFunctionImport(t,true);if(!o){throw new Error(`Function import "${t}" not found`)}const i=this.getObject(o);const r=e.findIndex(i.parameter,n);if(r<0){throw new Error(`Parameter "${n}" not found for function import "${t}"`)}return this.createBindingContext(o+"/parameter/"+r)};b.prototype.getODataProperty=function(t,n,o){var i,r=Array.isArray(n)?n:[n],a=null,s;while(t&&r.length){i=e.findIndex(t.property,r[0]);if(i<0){break}r.shift();a=t.property[i];s=t.$path+"/property/"+i;if(r.length){t=this.getODataComplexType(a.type)}}return o?s:a};b.prototype.getODataValueLists=function(t){var o=false,i,r=t.getPath(),a=this.mContext2Promise[r],s=this;if(a){return a}let d=false;i=C.exec(r);if(!i){i=O.exec(r);d=true}if(!i){throw new Error(`"${r}" neither references a property nor a function import parameter`)}a=new Promise(function(a,l){var c=t.getObject(),u=e.getValueLists(c);const p=""in u&&s.getODataEntitySet(u[""].CollectionPath.String);if(!p&&c["sap:value-list"]){o=true;const t=s.oModel.getObject(i[i.length-1]).namespace+"."+s.oModel.getObject(i[i.length-2]).name;const p=(d?s.oModel.getObject(i[1]).name+"/":"")+c.name;s.mQName2PendingRequest[t+"/"+p]={resolve:function(o){const i=o.annotations[d?"EntityContainer":"propertyAnnotations"]?.[t]?.[p]||{};Object.keys(i).forEach(e=>{if(!c.hasOwnProperty(e)){c[e]=i[e]}});u=e.getValueLists(c);if(n(u)){l(new Error("No value lists returned for "+r))}else{delete s.mContext2Promise[r];a(u)}},reject:l};setTimeout(s._sendBundledRequest.bind(s),0)}else{a(u)}});if(o){this.mContext2Promise[r]=a}return a};b.prototype.getProperty=function(){return this._getObject.apply(this,arguments)};b.prototype.isList=function(){return this.oModel.isList.apply(this.oModel,arguments)};b.prototype.loaded=function(){return this.oLoadedPromise};b.prototype.refresh=function(){throw new Error("Unsupported operation: ODataMetaModel#refresh")};b.prototype.requestCurrencyCodes=function(){return Promise.resolve(this.fetchCodeList("CurrencyCodes")).then(function(e){return e?a.merge({},e):e})};b.prototype.requestUnitsOfMeasure=function(){return Promise.resolve(this.fetchCodeList("UnitsOfMeasure")).then(function(e){return e?a.merge({},e):e})};b.prototype.setLegacySyntax=function(e){if(e){throw new Error("Legacy syntax not supported by ODataMetaModel")}};b.prototype.setProperty=function(){throw new Error("Unsupported operation: ODataMetaModel#setProperty")};b.prototype._getPropertyNamesForCodeListCustomizing=function(e){var t="/"+e+"/##",n=this.oDataModel.getObject(t),o=n["Org.OData.Core.V1.AlternateKeys"],i=b._getKeyPath(n,t),r=this.oDataModel.getObject("/"+e+"/"+i+"/##");if(o){if(o.length!==1){throw new Error("Single alternative expected: "+t+"Org.OData.Core.V1.AlternateKeys")}else if(o[0].Key.length!==1){throw new Error("Single key expected: "+t+"Org.OData.Core.V1.AlternateKeys/0/Key")}i=o[0].Key[0].Name.Path}return{code:i,standardCode:r["com.sap.vocabularies.CodeList.v1.StandardCode"]&&r["com.sap.vocabularies.CodeList.v1.StandardCode"].Path,text:r["com.sap.vocabularies.Common.v1.Text"].Path,unitSpecificScale:r["com.sap.vocabularies.Common.v1.UnitSpecificScale"].Path}};b._getKeyPath=function(e,t){var n=e.key.propertyRef;if(n&&n.length===1){return n[0].name}throw new Error("Single key expected: "+t)};b.getCodeListTerm=function(e){if(e==="/##@@requestCurrencyCodes"){return"CurrencyCodes"}else if(e==="/##@@requestUnitsOfMeasure"){return"UnitsOfMeasure"}return undefined};return b});
//# sourceMappingURL=ODataMetaModel.js.map