/*!
 * OpenUI5
 * (c) Copyright 2009-2024 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/config","sap/ui/thirdparty/URI","sap/ui/Device","sap/ui/performance/trace/Passport","sap/ui/performance/trace/Interaction","sap/ui/performance/XHRInterceptor","sap/ui/performance/BeaconRequest","sap/base/util/Version"],function(e,t,n,r,i,o,a,s){"use strict";const u=e.get({name:"sapUiFesrEnv",type:e.Type.String,external:true});var p=false,c,f,d,m=r.getRootId(),S=window.location.host,g=n.os.name+"_"+n.os.version,l=`${n.browser.reportingName}_${n.browser.version}${u?":"+u:""}`,v=b(),R="",P="",T,h=0,A="undetermined",I="undetermined_startup_0",y,E,N=new WeakMap;function b(){var e=0;if(n.system.combi){e=1}else if(n.system.desktop){e=2}else if(n.system.tablet){e=4}else if(n.system.phone){e=3}return e}function w(e){var t=new Date(e);return t.toISOString().replace(/[^\d]/g,"")}function F(e){var n=new t(e.toString()).host();return n&&n!==S}function _(){if(!F(arguments[1])){if(!T){T=r.getTransactionId()}var e=r.header(r.traceFlags(),m,r.getTransactionId(),A,I);this.setRequestHeader("SAP-PASSPORT",e);N.set(this,e)}}function H(){if(!F(arguments[1])){if(y&&E){this.setRequestHeader("SAP-Perf-FESRec",y);this.setRequestHeader("SAP-Perf-FESRec-opt",E);y=null;E=null;T=r.getTransactionId()}}}function q(e,t){return[D(m,32),D(T,32),M(e.navigation,4),M(e.roundtrip,4),M(t.timeToInteractive,4),M(e.completeRoundtrips,2),D(I,40,true),M(e.networkTime,4),M(e.requestTime,4),D(g,10),"SAP_UI5"].join(",")}function O(e,t){return[D(t.appNameShort,20,true),D(t.stepName,20,true),"",D(l,20),M(e.bytesSent,4),M(e.bytesReceived,4),"","",M(e.processing,4),e.requestCompression?"X":"","","","","",M(e.busyDuration,4),M(t.interactionType||0,4),D(v,1),"",D(w(e.start),20),D(t.appNameLong,70,true)].join(",")}function D(e,t,n){if(!e){e=e===0?"0":""}else if(typeof e==="number"){var r=e;e=Math.round(e).toString();if(e.length>t||r<0){e="-1"}}else{e=n?e.substr(-t,t):e.substr(0,t)}return e}function M(e,t){if(typeof e!=="number"){e=""}else{var n=Math.pow(256,t)/2-1;e=Math.round(e);e=e>=0&&e<=n?e.toString():"-1"}return e}function C(e){var t=new s(e);return"@"+t.getMajor()+"."+t.getMinor()+"."+t.getPatch()}function L(e,t){y=q(e,t);E=O(e,t)}function B(e){h++;A=e?e.component+R:undefined;I=e?e.trigger+"_"+e.event+"_"+h:undefined;return I}function U(e){if(e){e.rootId=r.getRootId();var t=e.semanticStepName?e.semanticStepName:e.trigger+"_"+e.event;var n=V.onBeforeCreated({stepName:t,appNameLong:e.stepComponent||e.component,appNameShort:e.stepComponent||e.component,timeToInteractive:e.duration,interactionType:k(t)},e);if(f||e.requests.length>0){L(e,n);if(f){T=null}}if(f&&y&&E){f.append("SAP-Perf-FESRec",y+"SAP-Perf-FESRec-opt"+E);j()}if(P!=e.appVersion){P=e.appVersion;R=P?C(P):""}}A="undefined";I="undefined"}function j(){if(!d){d=setTimeout(function(){f.send();clearTimeout(d);d=undefined},6e4)}}function k(e){var t=2;if(e.indexOf("startup")!==-1){t=1}return t}var V={};V.getBeaconURL=function(){return c};V.setActive=async function(e,t){if(e&&!p){f=t?a.isSupported()&&new a({url:t}):null;c=t;p=true;r.setActive(true);await i.setActive(true);o.register("PASSPORT_HEADER","open",_);if(!f){o.register("FESR","open",H)}i.setFESR(V)}else if(!e&&p){p=false;await i.setActive(false);o.unregister("FESR","open");if(o.isRegistered("PASSPORT_HEADER","open")){o.register("PASSPORT_HEADER","open",function(){this.setRequestHeader("SAP-PASSPORT",r.header(r.traceFlags(),m,r.getTransactionId()))})}if(f){f.send();clearTimeout(d);d=null;f=null;c=null}i.setFESR(null)}};V.getActive=function(){return p};V.onBeforeCreated=function(e,t){return{stepName:e.stepName,appNameLong:e.appNameLong,appNameShort:e.appNameShort,timeToInteractive:e.timeToInteractive,interactionType:e.interactionType}};V.onInteractionStarted=B;V.onInteractionFinished=U;V.passportHeader=N;return V});
//# sourceMappingURL=FESR.js.map