/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/base/BindingInfo","sap/ui/base/ManagedObject","sap/ui/core/Element","sap/ui/core/ElementRegistry","sap/ui/core/LabelEnablement"],function(e,t,o,s,n,i){"use strict";const a="sap/ui/core/fieldhelp/FieldHelp";const r="com.sap.vocabularies.Common.v1.DocumentationRef";let l;const c="urn:sap-com:documentation:key?=";function p(e){if(e){l._updateProperty(this,e)}else{l._updateElement(this)}}class d{#e=false;#t=null;#o={};#s=null;#n=new Map;#i=new Map;static#a={getDocumentationRef(e){return this.oMetaModel.getObject("@"+r,this.oMetaModel.getMetaContext(e))},getProperties(e){return Object.keys(e).filter(t=>e[t].$kind==="Property")},getTextPropertyPath(e,t){return this.oMetaModel.getObject(`/${e}/${t}@com.sap.vocabularies.Common.v1.Text/$Path`)},getTypeQName(e){return this.oMetaModel.getObject(this.oMetaModel.getMetaPath(e)+"/$Type")},async requestTypes(){const e=new Map;const t=new Map;const o=await this.oMetaModel.requestObject("/$");Object.entries(o).forEach(([o,s])=>{if(s.$kind==="EntityType"){e.set(o,s)}else if(s.$kind==="ComplexType"){t.set(o,s)}});return[e,t]}};static#r={getDocumentationRef(e){return this.oMetaModel.getObject("",this.oMetaModel.getMetaContext(e))[r]?.String},getProperties(e){return e.property?.map(e=>e.name)??[]},getTextPropertyPath(e,t,o,s,n){const i=n?"complexType":"entityType";return this.oMetaModel.getObject(`/dataServices/schema/0/${i}/${o}/property/${s}`+"/com.sap.vocabularies.Common.v1.Text")?.Path},getTypeQName(e){let t;try{t=this.oMetaModel.getMetaContext(e)}catch(t){const o=new Error(`Failed to determine type QName for path '${e}'`);o.cause=t;throw o}const o=this.oMetaModel.getObject("",t);if(o.namespace){return`${o.namespace}.${o.name}`}return o.type},async requestTypes(){await this.oMetaModel.loaded();const e=this.oMetaModel.getObject("/dataServices/schema/0");const t=e=>new Map(e?.map(e=>[`${e.namespace}.${e.name}`,e])??[]);return[t(e.entityType),t(e.complexType)]}};static _getMetamodelInterface(e){if(!e){return undefined}let t;if(e.isA("sap.ui.model.odata.v4.ODataModel")){t=Object.create(d.#a)}else if(e.isA("sap.ui.model.odata.v2.ODataModel")){t=Object.create(d.#r)}else{return undefined}t.oMetaModel=e.getMetaModel();return t}async _requestIDPropertyPath(e,t){const o=await this._requestText2IdByType(e);const[s,...n]=t.slice(1).split("/");const i=[s];while(n.length){const t="/"+i.join("/");const s=e.getTypeQName(t);const a=n.join("/");const r=o.get(a)?.get(s);if(r){return t+"/"+r}i.push(n.shift())}return t}_requestText2IdByType(e){const t=e.oMetaModel;if(this.#n.has(t)){return this.#n.get(t)}const o=e.requestTypes().then(([o,s])=>{const n=this.#i.get(t);const i=n?.text2IdByType??new Map;const a=n?.visitedTypes??new Set;const r=new Map([...o,...s]);const l=o.size;let c=0;for(const[t,o]of r){const s=c>=l;const n=s?c-l:c;c+=1;if(a.has(t)){continue}a.add(t);e.getProperties(o).forEach((o,a)=>{const r=e.getTextPropertyPath(t,o,n,a,s);if(!r){return}const l=i.get(r)??i.set(r,new Map).get(r);l.set(t,o)})}this.#i.set(t,{text2IdByType:i,visitedTypes:a});return i});this.#n.set(e.oMetaModel,o);return o}async _requestDocumentationRef(t){if(t.isDestroyed()){return undefined}let o=t.getResolvedPath();if(!o||o.includes("#")||o.includes("@")){return undefined}const s=d._getMetamodelInterface(t.getModel());if(!s){return undefined}let n;try{const e=await this._requestIDPropertyPath(s,o);o=e;n=s.getDocumentationRef(e)}catch(t){e.error(`Failed to request '${r}' annotation for path '${o}'`,t,a)}return n}_getFieldHelpDisplayMapping(){const e={};for(const o in this.#o){const n=s.getElementById(o);if(!n){delete this.#o[o];continue}let i;let a=n;do{i=a.getAssociation("fieldHelpDisplay")||a[t.OriginalParent]?.getId();a=a.getParent()}while(!i&&a);if(i){e[o]=i}}return e}_getFieldHelpHotspots(){const t=this._getFieldHelpDisplayMapping();const o=new Map;const n=[];Object.keys(this.#o).forEach(e=>{const s=t[e]||e;const n=o.get(s)??o.set(s,new Set).get(s);const i=this.#o[e][undefined];const a=i?[i]:Object.values(this.#o[e]);a.forEach(e=>{e.forEach(n.add.bind(n))})});for(const[t,r]of o){const o=s.getElementById(t);const l=i._getLabelTexts(o)[0];if(!l){e.error(`Cannot find a label for control '${t}'; ignoring field help`,Array.from(r).join(),a);continue}for(const e of r){const o=new URLSearchParams(e.slice(c.length));const s=o.get("origin");n.push({backendHelpKey:{id:o.get("id"),type:o.get("type"),...s&&{origin:s}},hotspotId:t,labelText:l})}}return n}_setFieldHelpDocumentationRefs(e,t,o){const s=e.getId();this.#o[s]||={};if(o.length>0){this.#o[s][t]=o}else{delete this.#o[s][t];if(Object.keys(this.#o[s]).length===0){delete this.#o[s]}}this._updateHotspots().catch(()=>{})}_updateElement(e,t){if(e.isDestroyed()||e.isDestroyStarted()){t=[]}else{t||=e.data("sap-ui-DocumentationRef")||[]}this._setFieldHelpDocumentationRefs(e,undefined,t)}_updateHotspots(){if(this.#s){return this.#s}let e,t;this.#s=new Promise((o,s)=>{e=o;t=s});setTimeout(()=>{if(this.isActive()){this.#t(this._getFieldHelpHotspots());this.#n.clear();e()}else{t()}this.#s=null},0);return this.#s}_updateProperty(e,t){if(e.getMetadata().getProperty(t)?.group!=="Data"){return}const o=e.getBinding(t);if(!o){return}let s;if(o.isA("sap.ui.model.CompositeBinding")){const e=o.getType()?.getPartsIgnoringMessages()||[];s=o.getBindings().filter((t,o)=>!e.includes(o))}else{s=[o]}Promise.all(s.map(e=>this._requestDocumentationRef(e))).then(o=>{o=o.filter(e=>e);this._setFieldHelpDocumentationRefs(e,t,o)})}static getInstance(){l||=new d;return l}activate(e){if(this.#e){if(this.#t!==e){throw new Error("The field help is active for a different update hotspots callback handler")}return}this.#e=true;this.#t=e;n.forEach(e=>{const t=e.data("sap-ui-DocumentationRef");if(t){this._updateElement(e,t)}else{Object.keys(e.getMetadata().getAllProperties()).forEach(t=>{this._updateProperty(e,t)})}});o.prototype.updateFieldHelp=p}deactivate(){this.#e=false;this.#o={};this.#t=null;this.#n.clear();this.#i.clear();o.prototype.updateFieldHelp=undefined}isActive(){return this.#e}}return d});
//# sourceMappingURL=FieldHelp.js.map