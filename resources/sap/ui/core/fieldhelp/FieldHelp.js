/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/base/BindingInfo","sap/ui/base/ManagedObject","sap/ui/core/Element","sap/ui/core/ElementRegistry","sap/ui/core/LabelEnablement"],function(e,t,o,n,s,i){"use strict";const a="sap/ui/core/fieldhelp/FieldHelp";const r="com.sap.vocabularies.Common.v1.DocumentationRef";let l;const c="urn:sap-com:documentation:key?=";function p(e,t){if(e.size!==t.size){return false}for(const o of e){if(!t.has(o)){return false}}return true}function d(e){if(e){l._updateProperty(this,e)}else{l._updateElement(this)}}class u{#e=false;#t=null;mDocuRefControlToFieldHelp={};#o=false;#n=new Map;#s=new Map;static#i={getDocumentationRef(e){return this.oMetaModel.getObject("@"+r,this.oMetaModel.getMetaContext(e))},getProperties(e){return Object.keys(e).filter(t=>e[t].$kind==="Property")},getTextPropertyPath(e,t){return this.oMetaModel.getObject(`/${e}/${t}@com.sap.vocabularies.Common.v1.Text/$Path`)},getTypeQName(e){return this.oMetaModel.getObject(this.oMetaModel.getMetaPath(e)+"/$Type")},async requestTypes(){const e=new Map;const t=new Map;const o=await this.oMetaModel.requestObject("/$");Object.entries(o).forEach(([o,n])=>{if(n.$kind==="EntityType"){e.set(o,n)}else if(n.$kind==="ComplexType"){t.set(o,n)}});return[e,t]}};static#a={getDocumentationRef(e){return this.oMetaModel.getObject("",this.oMetaModel.getMetaContext(e))[r]?.String},getProperties(e){return e.property?.map(e=>e.name)??[]},getTextPropertyPath(e,t,o,n,s){const i=s?"complexType":"entityType";return this.oMetaModel.getObject(`/dataServices/schema/0/${i}/${o}/property/${n}`+"/com.sap.vocabularies.Common.v1.Text")?.Path},getTypeQName(e){let t;try{t=this.oMetaModel.getMetaContext(e)}catch(t){const o=new Error(`Failed to determine type QName for path '${e}'`);o.cause=t;throw o}const o=this.oMetaModel.getObject("",t);if(o.namespace){return`${o.namespace}.${o.name}`}return o.type},async requestTypes(){await this.oMetaModel.loaded();const e=this.oMetaModel.getObject("/dataServices/schema/0");const t=e=>new Map(e?.map(e=>[`${e.namespace}.${e.name}`,e])??[]);return[t(e.entityType),t(e.complexType)]}};static _getMetamodelInterface(e){if(!e){return undefined}let t;if(e.isA("sap.ui.model.odata.v4.ODataModel")){t=Object.create(u.#i)}else if(e.isA("sap.ui.model.odata.v2.ODataModel")){t=Object.create(u.#a)}else{return undefined}t.oMetaModel=e.getMetaModel();return t}async _requestIDPropertyPath(e,t){const o=await this._requestText2IdByType(e);const[n,...s]=t.slice(1).split("/");const i=[n];while(s.length){const t="/"+i.join("/");const n=e.getTypeQName(t);const a=s.join("/");const r=o.get(a)?.get(n);if(r){return t+"/"+r}i.push(s.shift())}return t}_requestText2IdByType(e){const t=e.oMetaModel;if(this.#n.has(t)){return this.#n.get(t)}const o=e.requestTypes().then(([o,n])=>{const s=this.#s.get(t);const i=s?.text2IdByType??new Map;const a=s?.visitedTypes??new Set;const r=new Map([...o,...n]);const l=o.size;let c=0;for(const[t,o]of r){const n=c>=l;const s=n?c-l:c;c+=1;if(a.has(t)){continue}a.add(t);e.getProperties(o).forEach((o,a)=>{const r=e.getTextPropertyPath(t,o,s,a,n);if(!r){return}const l=i.get(r)??i.set(r,new Map).get(r);l.set(t,o)})}this.#s.set(t,{text2IdByType:i,visitedTypes:a});return i});this.#n.set(e.oMetaModel,o);return o}async _requestDocumentationRef(t){if(t.isDestroyed()){return undefined}let o=t.getResolvedPath();if(!o||o.includes("#")||o.includes("@")){return undefined}const n=u._getMetamodelInterface(t.getModel());if(!n){return undefined}let s;try{const e=await this._requestIDPropertyPath(n,o);o=e;s=n.getDocumentationRef(e)}catch(t){e.error(`Failed to request '${r}' annotation for path '${o}'`,t,a)}return s}_getFieldHelpDisplayMapping(){const e={};for(const o in this.mDocuRefControlToFieldHelp){const s=n.getElementById(o);if(!s){delete this.mDocuRefControlToFieldHelp[o];continue}let i;let a=s;do{i=a.getAssociation("fieldHelpDisplay")||a[t.OriginalParent]?.getId();a=a.getParent()}while(!i&&a);if(i){e[o]=i}}return e}_getDisplayControlIDToURNs(){const t=this._getFieldHelpDisplayMapping();const o=new Map;const n=new Map;const s=new Map;for(const i in this.mDocuRefControlToFieldHelp){const r=t[i]||i;const l=this.mDocuRefControlToFieldHelp[i][undefined];if(l){const s=new Set(l);if(t[i]){const t=o.get(r);if(t&&!p(s,t)){e.error("Cannot display field help for control '"+i+"': different field help already set on hotspot '"+r+"'",undefined,a);continue}o.set(r,s)}else{n.set(r,s)}}else{const e=Object.values(this.mDocuRefControlToFieldHelp[i]).flat();const t=s.get(r)??new Set;e.forEach(t.add.bind(t));s.set(r,t)}}return new Map([...s,...o,...n])}_getFieldHelpHotspots(){const t=[];for(const[o,s]of this._getDisplayControlIDToURNs()){const r=n.getElementById(o);const l=i._getLabelTexts(r)[0];if(!l){e.error(`Cannot find a label for control '${o}'; ignoring field help`,Array.from(s).join(),a);continue}for(const e of s){const n=new URLSearchParams(e.slice(c.length));const s=n.get("origin");t.push({backendHelpKey:{id:n.get("id"),type:n.get("type"),...s&&{origin:s}},hotspotId:o,labelText:l})}}return t}_setFieldHelpDocumentationRefs(e,t,o){const n=e.getId();this.mDocuRefControlToFieldHelp[n]||={};if(o.length>0){this.mDocuRefControlToFieldHelp[n][t]=o}else{delete this.mDocuRefControlToFieldHelp[n][t];if(Object.keys(this.mDocuRefControlToFieldHelp[n]).length===0){delete this.mDocuRefControlToFieldHelp[n]}}this._updateHotspots()}_updateElement(e,t){if(e.isDestroyed()||e.isDestroyStarted()){t=[]}else{t||=e.data("sap-ui-DocumentationRef")||[]}this._setFieldHelpDocumentationRefs(e,undefined,t)}_updateHotspots(){if(this.#o){return}this.#o=true;setTimeout(()=>{if(this.isActive()){this.#t(this._getFieldHelpHotspots());this.#n.clear()}this.#o=false},0)}_updateProperty(e,t){if(e.getMetadata().getProperty(t)?.group!=="Data"){return}const o=e.getBinding(t);if(!o){return}let n;if(o.isA("sap.ui.model.CompositeBinding")){const e=o.getType()?.getPartsIgnoringMessages()||[];n=o.getBindings().filter((t,o)=>!e.includes(o))}else{n=[o]}Promise.all(n.map(e=>this._requestDocumentationRef(e))).then(o=>{o=o.filter(e=>e);this._setFieldHelpDocumentationRefs(e,t,o)})}static getInstance(){l||=new u;return l}activate(e){if(this.#e){if(this.#t!==e){throw new Error("The field help is active for a different update hotspots callback handler")}return}this.#e=true;this.#t=e;s.forEach(e=>{const t=e.data("sap-ui-DocumentationRef");if(t){this._updateElement(e,t)}else{Object.keys(e.getMetadata().getAllProperties()).forEach(t=>{this._updateProperty(e,t)})}});o.prototype.updateFieldHelp=d}deactivate(){this.#e=false;this.mDocuRefControlToFieldHelp={};this.#t=null;this.#n.clear();this.#s.clear();o.prototype.updateFieldHelp=undefined}isActive(){return this.#e}}return u});
//# sourceMappingURL=FieldHelp.js.map