/*!
 * OpenUI5
 * (c) Copyright 2009-2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/base/BindingInfo","sap/ui/base/ManagedObject","sap/ui/core/Element","sap/ui/core/ElementRegistry","sap/ui/core/LabelEnablement"],function(e,t,o,s,i,n){"use strict";const a="sap/ui/core/fieldhelp/FieldHelp";const r="com.sap.vocabularies.Common.v1.DocumentationRef";let l;const c="urn:sap-com:documentation:key?=";function p(e){if(e){l._updateProperty(this,e)}else{l._updateElement(this)}}class d{#e=false;#t=null;#o={};#s=null;static#i=new Map;static#n={getProperties(e){return Object.keys(e).filter(t=>e[t].$kind==="Property")},getTextPropertyPath(e,t){return this.oMetaModel.getObject(`/${e}/${t}@com.sap.vocabularies.Common.v1.Text/$Path`)},getTypeQName(e){return this.oMetaModel.getObject(this.oMetaModel.getMetaPath(e)+"/$Type")},async requestTypes(){const e=new Map;const t=new Map;const o=await this.oMetaModel.requestObject("/$");Object.entries(o).forEach(([o,s])=>{if(s.$kind==="EntityType"){e.set(o,s)}else if(s.$kind==="ComplexType"){t.set(o,s)}});return[e,t]}};static _getMetamodelInterface(e){if(e.isA("sap.ui.model.odata.v4.ODataMetaModel")){const t=Object.create(d.#n);t.oMetaModel=e;return t}return undefined}static async _requestIDPropertyPath(e,t){const o=await d._requestText2IdByType(e);const[s,...i]=t.slice(1).split("/");const n=[s];while(i.length){const t="/"+n.join("/");const s=e.getTypeQName(t);const a=i.join("/");const r=o.get(a)?.get(s);if(r){return t+"/"+r}n.push(i.shift())}return t}static _requestText2IdByType(e){if(d.#i.has(e.oMetaModel)){return d.#i.get(e.oMetaModel)}const t=e.requestTypes().then(([t,o])=>{const s=new Map;const i=new Map([...t,...o]);for(const[t,o]of i){for(const i of e.getProperties(o)){const o=e.getTextPropertyPath(t,i);if(!o){continue}const n=s.get(o)??s.set(o,new Map).get(o);n.set(t,i)}}return s});d.#i.set(e.oMetaModel,t);return t}static _requestDocumentationRef(t){if(t.isDestroyed()){return undefined}let o=t.getResolvedPath();if(!o||o.includes("#")||o.includes("@")){return undefined}const s=t.getModel()?.getMetaModel();if(!s||!s.getMetaContext){return undefined}let i;if(s.isA("sap.ui.model.odata.ODataMetaModel")){i=s.loaded().then(()=>s.getObject("",s.getMetaContext(o))?.[r]?.String)}else{const e=d._requestIDPropertyPath(d._getMetamodelInterface(s),o);i=e.then(e=>{o=e;return s.requestObject("@"+r,s.getMetaContext(o))})}return i.catch(t=>{e.error(`Failed to request '${r}' annotation for path '${o}'`,t,a);return undefined})}_getFieldHelpDisplayMapping(){const e={};for(const o in this.#o){const i=s.getElementById(o);if(!i){delete this.#o[o];continue}let n;let a=i;do{n=a.getAssociation("fieldHelpDisplay")||a[t.OriginalParent]?.getId();a=a.getParent()}while(!n&&a);if(n){e[o]=n}}return e}_getFieldHelpHotspots(){const t=this._getFieldHelpDisplayMapping();const o={};const i=[];Object.keys(this.#o).forEach(r=>{const l=t[r]||r;const p=s.getElementById(l);const d=n._getLabelTexts(p)[0];if(!d){e.error(`Cannot find a label for control '${r}'; ignoring field help`,JSON.stringify(this.#o[r]),a);return}const u=new Set;Object.values(this.#o[r]).forEach(e=>{e.forEach(u.add.bind(u))});Array.from(u).forEach(e=>{if(o[l]?.[e]){return}o[l]??={};o[l][e]=true;const t=new URLSearchParams(e.slice(c.length));const s=t.get("origin");i.push({backendHelpKey:{id:t.get("id"),type:t.get("type"),...s&&{origin:s}},hotspotId:l,labelText:d})})});return i}_setFieldHelpDocumentationRefs(e,t,o){const s=e.getId();this.#o[s]||={};if(o.length>0){this.#o[s][t]=o}else{delete this.#o[s][t];if(Object.keys(this.#o[s]).length===0){delete this.#o[s]}}this._updateHotspots().catch(()=>{})}_updateElement(e,t){if(e.isDestroyed()||e.isDestroyStarted()){t=[]}else{t||=e.data("sap-ui-DocumentationRef")||[]}this._setFieldHelpDocumentationRefs(e,undefined,t)}_updateHotspots(){if(this.#s){return this.#s}let e,t;this.#s=new Promise((o,s)=>{e=o;t=s});setTimeout(()=>{if(this.isActive()){this.#t(this._getFieldHelpHotspots());e()}else{t()}this.#s=null},0);return this.#s}_updateProperty(e,t){if(e.getMetadata().getProperty(t)?.group!=="Data"){return}const o=e.getBinding(t);if(!o){return}let s;if(o.isA("sap.ui.model.CompositeBinding")){const e=o.getType()?.getPartsIgnoringMessages()||[];s=o.getBindings().filter((t,o)=>!e.includes(o))}else{s=[o]}Promise.all(s.map(e=>d._requestDocumentationRef(e))).then(o=>{o=o.filter(e=>e);this._setFieldHelpDocumentationRefs(e,t,o)})}static getInstance(){l||=new d;return l}activate(e){if(this.#e){if(this.#t!==e){throw new Error("The field help is active for a different update hotspots callback handler")}return}this.#e=true;this.#t=e;i.forEach(e=>{const t=e.data("sap-ui-DocumentationRef");if(t){this._updateElement(e,t)}else{Object.keys(e.getMetadata().getAllProperties()).forEach(t=>{this._updateProperty(e,t)})}});o.prototype.updateFieldHelp=p}deactivate(){this.#e=false;this.#o={};this.#t=null;d.#i.clear();o.prototype.updateFieldHelp=undefined}isActive(){return this.#e}}return d});
//# sourceMappingURL=FieldHelp.js.map